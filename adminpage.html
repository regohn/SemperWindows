<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Page</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <!-- Font Awesome for arrow icon -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background: linear-gradient(135deg, #4e54c8, #8f94fb);
      margin: 0;
      padding: 0;
    }
    .form-container {
      background: white;
      padding: 2.5rem; /* added extra padding */
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.15);
      width: 100%;
      max-width: 600px;
      margin: 2rem auto;
    }
    .logo {
      display: block;
      margin: 0 auto 1.5rem;
      max-width: 200px;
      width: 100%;
      height: auto;
    }
    h2 {
      text-align: center;
      margin-bottom: 1.5rem;
      color: #333;
    }
    .form-group {
      margin-bottom: 1.5rem; /* more spacing */
    }
    label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 600;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1rem;
      transition: border-color 0.3s ease;
    }
    input:focus, select:focus {
      border-color: #4e54c8;
      outline: none;
    }
    button {
      background-color: #4e54c8;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      font-size: 1rem;
      font-weight: 600;
      transition: background-color 0.3s ease, transform 0.2s ease;
    }
    button:hover {
      background-color: #3f45b1;
      transform: translateY(-2px);
    }
    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .button-group button {
      flex: 1;
    }
    #statusMessage {
      text-align: center;
      margin-top: 10px;
      font-size: 0.95rem;
      font-weight: 600;
      color: #333;
    }
    @media (max-width: 480px) {
      .form-container {
        padding: 1.5rem;
      }
      .logo {
        max-width: 150px;
      }
    }
    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color: transparent;
      color: white;
    }
    .logoff-link {
      color: #fff;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      padding: 8px 12px;
      border: 1px solid #fff;
      border-radius: 6px;
      transition: background-color 0.2s, color 0.2s;
    }
    .logoff-link:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    /* Dynamic dropdowns in table format */
    .dynamic-table {
      border-collapse: collapse;
      width: 100%; /* Changed to 100% for better layout */
      margin-top: 10px;
    }
    .dynamic-table td {
      padding: 6px 8px;
      vertical-align: middle;
    }
    .dynamic-table label {
      font-size: 0.85rem;
      font-weight: 500;
      white-space: nowrap;
      margin-right: 6px;
      color: #333;
    }
    .dynamic-table select {
      font-size: 0.85rem;
      padding: 6px;
      border-radius: 6px;
      width: 100%; /* Changed to 100% */
      box-sizing: border-box; /* Include padding in width */
    }

    /* Jump buttons */
    .jump-container {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      z-index: 999;
    }
    .jump-button {
      width: 10%;
      min-width: 90px;
      max-width: 140px;
      padding: 6px 10px;
      background-color: #4e54c8;
      color: white;
      border: none;
      border-radius: 50px;
      font-size: 13px;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
      transition: opacity 0.6s ease, transform 0.2s ease, background 0.3s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      opacity: 0;
      pointer-events: none;
    }
    .jump-button.show {
      opacity: 1;
      pointer-events: auto;
    }

    /* Arrow Link for additional features */
    .additional-features-toggle {
      background: none;
      border: none;
      color: #4e54c8;
      cursor: pointer;
      font-size: 1.2rem;
      margin-left: 10px;
      vertical-align: middle;
      display: inline-block;
    }
    .additional-features-toggle:hover {
      color: #3f45b1;
    }

    /* Container for additional feature dropdowns */
    .additional-features-container {
      margin-top: 10px;
      padding: 10px;
      border: 1px solid #eee;
      border-radius: 8px;
      background-color: #f9f9f9;
      display: none; /* Hidden by default */
      flex-wrap: wrap; /* Allow items to wrap */
      gap: 10px; /* Space between dropdowns */
      justify-content: space-between; /* Distribute items */
    }

    .additional-features-container .form-group-inline {
      flex: 1 1 calc(33% - 10px); /* Approx 3 items per row, with gap */
      min-width: 150px; /* Minimum width for each dropdown container */
      box-sizing: border-box;
    }

    .additional-features-container .form-group-inline label {
      font-size: 0.8rem;
      margin-bottom: 5px;
    }
    .additional-features-container .form-group-inline select {
      padding: 8px;
      font-size: 0.9rem;
    }

    /* Dynamic table for added additional features */
.added-features-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
  font-size: 0.65rem; /* Reduced font size for the entire table */
}
.added-features-table th, .added-features-table td {
  border: 1px solid #ddd;
  padding: 8px;
  text-align: left;
}
.added-features-table th {
  background-color: #f2f2f2;
  font-weight: 600;
}
.added-features-table tbody tr:nth-child(even) {
  background-color: #f9f9f9;
}
.added-features-table .delete-btn {
  background-color: #dc3545;
  color: white;
  border: none;
  padding: 5px 8px;
  border-radius: 5px;
  cursor: pointer;
  font-size: 0.8rem;
}
.added-features-table .delete-btn:hover {
  background-color: #c82333;
}

    .center-button {
      display: flex;
      justify-content: center;
      margin-top: 15px;
    }
    .center-button button {
      width: auto;
      padding: 8px 20px;
      font-size: 0.9rem;
    }
input, select, textarea {
  width: 100%;
  padding: 10px;
  border: 1px solid #ddd;
  border-radius: 8px;
  font-size: 1rem;
  transition: border-color 0.3s ease;
  box-sizing: border-box; /* This is important for consistent sizing */
}   
  </style>
</head>
<body>
  
  <div class="header-bar">
    <span>Welcome, <span id="userName"></span>!</span>
    <a href="adminsprojectsummary.html" class="logoff-link"> Project Summary</a>
    <a href="#" class="logoff-link" onclick="logoff()">Logoff</a>
  </div>
  
  <script>
    function logoff() {
        sessionStorage.removeItem('installer');
        sessionStorage.removeItem('role');
        window.location.href = 'windowsloginpage.html';
    }
    const rawUserName = sessionStorage.getItem('installer');
    const displayUserName = rawUserName ? rawUserName.split('@')[0] : 'Guest';
    document.getElementById('userName').textContent = displayUserName;
  </script>
  
  <div class="form-container">
    <img src="https://www.sempersolaris.com/wp-content/uploads/Semper-Logo-w-Services-3.webp" alt="Semper Solaris Logo" class="logo">
    <h2>Administrator</h2>
    
    <form id="adminForm">
      <div class="form-group">
        <label>Project Number</label>
        <div id="projectWarning" style="color:red;font-weight:bold;display:none;"></div>
        <input type="text" id="projectNumberInput" name="projectNumber" required>
      </div>
      <div class="form-group">
        <label>Address</label>
        <input type="text" name="address" required>
      </div>
      <div class="form-group">
        <label>Customer Name</label>
        <input type="text" name="customerName" required>
      </div>
      <div class="form-group">
        <label>Customer Number</label>
        <input type="text" name="customerNumber" required>
      </div>
      <div class="form-group">
        <label>Year the home was constructed</label>
        <input type="number" name="yearConstructed" min="1800" max="2099" required>
      </div>
      <div class="form-group">
        <label>Fire Classification</label>
        <select name="fireClassification" required>
          <option value="">Select...</option>
          <option value="Class WUI">Class WUI Red</option>
          <option value="Class A Orange/Yellow">Class A</option>
          <option value="Not in Fire Zone">Not in Fire Zone Grey</option>
        </select>
      </div>

      <!-- Dynamic Windows -->
      <div class="form-group">
        <label>How many Windows Sold</label>
        <input type="number" id="windowsSold" name="windowsSold" min="0" required>
        <table id="windowsDetails" class="dynamic-table"></table>
        <!-- Container for dynamically added additional features for windows -->
        <div id="additionalFeaturesTableContainer">
          <table class="added-features-table" id="addedWindowsFeaturesTable">
            <thead>
              <tr>
                <th>Project Number</th>
                <th>Product Category</th>
                <th>Item Number</th>
                <th>Product Type</th>
                <th>Addtnl Feat.</th>
                <th>Addtnl Feat. Val.</th>
                <th>XOX/XO</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <!-- Dynamic rows will be added here -->
            </tbody>
          </table>
        </div>
      </div>

<div class="table-section">
  <h3>Doors Sold</h3>
  <div class="form-group">
    <label>How many Doors Sold</label>
    <input type="number" id="doorsSold" name="doorsSold" min="0" required>
    <table id="doorsDetails" class="dynamic-table">
        <tbody id="doorsDropdowns">
            </tbody>
    </table>
  </div>
  
  <div id="addedDoorsFeaturesTableContainer">
      <table class="added-features-table" id="addedDoorsFeaturesTable">
          <thead>
              <tr>
                  <th>Project Number</th>
                  <th>Product Category</th>
                  <th>Item Number</th>
                  <th>Product Type</th>
                  <th>Addtnl Feat.</th>
                  <th>Addtnl Feat. Val.</th>
                  <th>XOX/XO</th>
                  <th>Actions</th>
              </tr>
          </thead>
          <tbody id="addedDoorsFeaturesTableBody">
              </tbody>
      </table>
  </div>
</div>

      <!-- Dynamic Glass Walls -->
      <div class="form-group">
        <label>How many Moving Glass Walls Sold</label>
        <input type="number" id="glassWallsSold" name="glassWallsSold" min="0">
        <table id="wallsDetails" class="dynamic-table"></table>
      </div>

      <div class="form-group">
        <label>Installer</label>
        <select name="installer" required>
          <option value="">Select...</option>
          <option value="ryan@levelupwindowsanddoors.com">ryan@levelupwindowsanddoors.com</option>
          <option value="exteriorexpertsinc@gmail.com">exteriorexpertsinc@gmail.com</option>
        </select>
      </div>
      <div class="form-group">
        <label>Visit Schedule Date</label>
        <input type="date" name="visitDate" required>
      </div>
      <div class="form-group">
        <label>Time Frame</label>
        <input type="text" name="timeFrame" required>
      </div>
      <div class="form-group">
          <label for="comments">Comments</label>
          <textarea id="comments" name="Admin Comments" rows="3" placeholder=""></textarea>
      </div>      
      <div class="button-group">
        <button type="submit">Submit</button>
        <button type="button" id="submitAdditionalFeaturesBtn" style="display:none;">Submit Additional Features</button>
        <button type="button" class="btn" id="showFeaturesBtn" style="display:none;">Show Additional Features Data</button>
        <button type="button" id="showDoorsFeaturesBtn" style="display:none;">Show Doors Additional Features Data</button>
      </div>
      <div id="statusMessage"></div>
    </form>
  </div>

  <!-- Jump to Top/Bottom -->
  <div class="jump-container">
    <button id="jumpTop" class="jump-button">Top ⬆</button>
    <button id="jumpBottom" class="jump-button">Bottom ⬇</button>
  </div>
  
  <script>
    const windowsSoldInput = document.getElementById('windowsSold');
    const doorsSoldInput = document.getElementById('doorsSold');
    const wallsSoldInput = document.getElementById('glassWallsSold');

    const windowsDetails = document.getElementById('windowsDetails');
    const doorsDetails = document.getElementById('doorsDetails');
    const wallsDetails = document.getElementById('wallsDetails');
    const addedWindowsFeaturesTableBody = document.querySelector('#addedWindowsFeaturesTable tbody');

    // Web App URL for additional features
    const ADDITIONAL_FEATURES_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyxFyynoELkEkEmNK4uto4A5dTUI9GTCUQakjGBCscNSWjX93CqY2soaiaLYRHeXlMddQ/exec';
async function submitAdditionalFeatures() {
    try {
        await fetch(ADDITIONAL_FEATURES_WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify(addedAdditionalFeatures),
            headers: {'Content-Type': 'application/json'},
            mode: 'no-cors'
        });

        showModal('Additional features submission initiated. Please check your Google Sheet to confirm.', true);
        
        // Clear the array and table after submission
        //addedAdditionalFeatures = [];
        //renderAddedFeaturesTable();
    } catch (error) {
        console.error('Error submitting additional features:', error);
        showModal('An error occurred while submitting additional features. Please try again.', false);
    }
}

// Additional Features Data Mapping
    const additionalFeaturesData = {
        "ProSolar Shade Plus": {
          "Window": ["ProSolar Shade Plus"],
          "Door": ["ProSolar Shade Plus"]
        },
        "Laminating": {
          "Window": ["Laminating"],
          "Door": ["Laminating"]
        },
        "Spectra Clear EZ Clean": {
          "Window": ["Spectra Clear EZ Clean"],
          "Door": ["Spectra Clear EZ Clean"]
        },
        "Obscure / Decorative": {
          "Window": ["Decorative Glass", "Obscure Glass"],
          "Door": ["Decorative Glass", "Obscure Glass"]
        },
        "Decorum": {
          "Window": [], // No values for windows
          "Door": ["Decorum"] // New value for doors
        },
        "CA Urban Wildlife Compliant": {
          "Window": ["CA Urban Wildlife Compliant"],
          "Door": [] // This feature is no longer available for doors
        },
        "Tempered both Sides": {
          "Window": ["Tempered both Sides"],
          "Door": [] // This feature is no longer available for doors
        },
        "Premium Frame Colors": {
          "Window": ["Painted Frames <120 UI", "Painted Frames>119 UI"],
          "Door": [] // This feature is no longer available for doors
        },
        "Mulled Units": {
          "Window": ["Color Matched Factory Mulled Units in addition to standard mull charge", "Color Matched Field Mulled Units per mullion in addition to standard mull charge"],
          "Door": [] // This feature is no longer available for doors
        },
        "Premium Lock and Casement Finishes": {
          "Window": ["Upgraded lock finishes", "Upgraded Casement Hardware Finishes"],
          "Door": [] // This feature is no longer available for doors
        },
        "Grids": {
          "Window": ["Standard Grid Patterns - Flat (W/T)", "Standard Grid Patterns - Contoured (W/T)"],
          "Door": [] // This feature is no longer available for doors
        },
        "Color Matched Grids": {
          "Window": ["Color Matched Grids", "Color Matched Grids in addition to standard sculptured grid pricing"],
          "Door": [] // This feature is no longer available for doors
        },
        "Sound Control Package": {
          "Window": ["Sound Control Glass"],
          "Door": [] // This feature is no longer available for doors
        },
        "Premium Screen": {
          "Window": ["Ultraview Screen"],
          "Door": [] // This feature is no longer available for doors
        }
    };
    // Window type options
    const windowOptions = `
      <option value="">Select...</option>
      <option value="Single Hung">Single Hung - SH</option>
      <option value="Slider Window">Slider Window - SL</option>
      <option value="End Vent Slider">End Vent Slider - EVSL</option>
      <option value="Picture Window">Picture Window - PW</option>
      <option value="Casement">Casement - CA</option>
      <option value="Casement Picture">Casement Picture</option>
      <option value="Casement & Picture">Casement & Picture</option>
      <option value="Casement-Picture">Casement-Picture</option>
      <option value="Casement-Casement">Casement-Casement</option>
      <option value="Single Awning">Single Awning - SA</option>
      <option value="Picture over Awning">Picture over Awning</option>
      <option value="Trap Top Single">Trap Top Single - TT</option>
      <option value="Arch Top Single">Arch Top Single - AT</option>
      <option value="Custom Shapes: (Specify in Notes)">Custom Shapes: (Specify in Notes)</option>
    `;

    // Updated door type options
    const doorOptions = `
      <option value="">Select...</option>
      <option value="2-Lite Contemporary Patio Doors">2-Lite Contemporary Patio Doors</option>
      <option value="2-Lite French Rail Patio Doors">2-Lite French Rail Patio Doors</option>
      <option value="3-Lite Contemporary Patio Doors">3-Lite Contemporary Patio Doors</option>
      <option value="3-Lite French Rail Patio Doors">3-Lite French Rail Patio Doors</option>
      <option value="4-Lite Contemporary Patio Doors">4-Lite Contemporary Patio Doors</option>
      <option value="4-Lite French Rail Patio Doors">4-Lite French Rail Patio Doors</option>
    `;
    const wallOptions = `
      <option value="">Select...</option>
      <option value="Wall1">Wall1</option>
      <option value="Wall2">Wall2</option>
      <option value="Wall3">Wall3</option>
    `;

function generateDropdowns(container, type, count, options) {
      container.innerHTML = '';
      const productCategory = type === 'window' ? 'Window' : (type === 'door' ? 'Door' : 'Glass Wall');

      for (let i = 1; i <= count; i++) {
        const row = document.createElement('tr');

        const labelCell = document.createElement('td');
        const label = document.createElement('label');
        let shortLabel = "";
        if (type === "window") shortLabel = `W${i} Type`;
        else if (type === "door") shortLabel = `D${i} Type`;
        else if (type === "wall") shortLabel = `GW${i} Type`;
        label.textContent = shortLabel;
        labelCell.appendChild(label);

        const selectCell = document.createElement('td');
        const select = document.createElement('select');
        select.name = `${type}Type_${i}`;
        select.id = `${type}Type_${i}`;
        select.required = true;
        select.innerHTML = options;
        selectCell.appendChild(select);

        row.appendChild(labelCell);
        row.appendChild(selectCell);

        // Add the right arrow link for additional features
        if (type === "window" || type === "door") {
          const arrowCell = document.createElement('td');
          const arrowLink = document.createElement('button');
          arrowLink.type = 'button';
          arrowLink.className = 'additional-features-toggle';
          arrowLink.innerHTML = '<i class="fas fa-arrow-circle-right"></i>';
          arrowLink.dataset.targetId = `additionalFeatures_${type}_${i}`;
          arrowLink.dataset.productCategory = productCategory;
          arrowLink.dataset.itemNumber = i;
          arrowLink.addEventListener('click', toggleAdditionalFeatures);
          arrowCell.appendChild(arrowLink);
          row.appendChild(arrowCell);
        }

        container.appendChild(row);

        // Append the additional features container after the row
        if (type === "window" || type === "door") {
            const additionalFeaturesRow = document.createElement('tr');
            const additionalFeaturesCell = document.createElement('td');
            additionalFeaturesCell.colSpan = 3;
            additionalFeaturesCell.innerHTML = `
                <div id="additionalFeatures_${type}_${i}" class="additional-features-container">
                    <div class="form-group-inline">
                        <label for="addtnlFeat_${type}_${i}">Addtnl Feat.</label>
                          <select id="addtnlFeat_${type}_${i}" class="addtnl-feat-select" 
                                  data-item-number="${i}" data-product-category="${productCategory}">
                            <option value="">Select Feature</option>
                            ${Object.keys(additionalFeaturesData)
                                .filter(key => additionalFeaturesData[key][productCategory] && additionalFeaturesData[key][productCategory].length > 0)
                                .map(key => `<option value="${key}">${key}</option>`)
                                .join('')}
                          </select>
                    </div>
                    <div class="form-group-inline">
                        <label for="addtnlFeatVal_${type}_${i}">Addtnl Feat. Val.</label>
                        <select id="addtnlFeatVal_${type}_${i}" class="addtnl-feat-val-select">
                            <option value="">Select Value</option>
                        </select>
                    </div>
                    <div class="form-group-inline">
                        <label for="xoxo_${type}_${i}">Orientation</label>
                        <select id="xoxo_${type}_${i}" class="xoxo-select">
                            <option value="">Select Value</option>
                            <option value="XOX">(OX)O</option>
                            <option value="XO">O(XO)</option>
                            <option value="XO">OX</option>
                            <option value="XO">OXXO</option>
                            <option value="XO">XO</option>
                            <option value="XO">XOO</option>

                        </select>
                    </div>
                    <div class="center-button" style="width: 100%;">
                        <button type="button" class="add-additional-feature-btn" data-item-number="${i}" data-product-category="${productCategory}">Add</button>
                    </div>
                </div>
            `;
            additionalFeaturesRow.appendChild(additionalFeaturesCell);
            container.appendChild(additionalFeaturesRow);
        }
      }

      // Add event listeners for dynamic dropdowns
      container.querySelectorAll('.addtnl-feat-select').forEach(select => {
          select.addEventListener('change', (event) => {
              const itemNumber = event.target.dataset.itemNumber;
              const productCategory = event.target.dataset.productCategory;
              const addtnlFeatValSelect = document.getElementById(`addtnlFeatVal_${productCategory.toLowerCase()}_${itemNumber}`);

              addtnlFeatValSelect.innerHTML = '<option value="">Select Value</option>'; // Clear existing options
              const selectedFeature = event.target.value;
              if (selectedFeature && additionalFeaturesData[selectedFeature] && additionalFeaturesData[selectedFeature][productCategory]) {
                  additionalFeaturesData[selectedFeature][productCategory].forEach(value => {
                      const option = document.createElement('option');
                      option.value = value;
                      option.textContent = value;
                      addtnlFeatValSelect.appendChild(option);
                  });
              }
          });
      });

      // Add event listeners for 'Add' buttons
      container.querySelectorAll('.add-additional-feature-btn').forEach(button => {
          button.addEventListener('click', addAdditionalFeatureToTable);
      });
    }

    // Function to toggle the visibility of additional features dropdowns
    function toggleAdditionalFeatures(event) {
        const targetId = event.currentTarget.dataset.targetId;
        const additionalFeaturesContainer = document.getElementById(targetId);
        if (additionalFeaturesContainer) {
            additionalFeaturesContainer.style.display = additionalFeaturesContainer.style.display === 'flex' ? 'none' : 'flex';
        }
    }

    // Array to store all added additional features
    let addedAdditionalFeatures = [];
    let addedAdditionalDoorsFeatures = []; // NEW: Array for doors-specific features

// Function to add selected additional feature to the dynamic table
function addAdditionalFeatureToTable(event) {
    const itemNumber = parseInt(event.currentTarget.dataset.itemNumber);
    const productCategory = event.currentTarget.dataset.productCategory;
    const projectNumber = document.getElementById('projectNumberInput').value.trim();

    if (!projectNumber) {
        showModal("Please enter a Project Number first.", false);
        return;
    }

    const productTypeDropdown = document.getElementById(`${productCategory.toLowerCase()}Type_${itemNumber}`);
    const productType = productTypeDropdown ? productTypeDropdown.value : '';

    const addtnlFeat = document.getElementById(`addtnlFeat_${productCategory.toLowerCase()}_${itemNumber}`).value;
    const addtnlFeatVal = document.getElementById(`addtnlFeatVal_${productCategory.toLowerCase()}_${itemNumber}`).value;
    const xoxo = document.getElementById(`xoxo_${productCategory.toLowerCase()}_${itemNumber}`).value;

    if (!addtnlFeat || !addtnlFeatVal || !xoxo || !productType) {
        showModal("Please select all additional feature dropdowns and product type before adding.", false);
        return;
    }

    const newFeature = {
        "Project Number": projectNumber,
        "Product Category": productCategory,
        "Item Number": itemNumber,
        "Product Type": productType,
        "Additonal Feature": addtnlFeat,
        "Additional Value": addtnlFeatVal,
        "XOX/XO": xoxo
    };

    // NEW: Check product category and add to the correct array
    if (productCategory === 'Door') {
        addedAdditionalDoorsFeatures.push(newFeature);
        renderAddedDoorsFeaturesTable(); // Render doors table
    } else {
        addedAdditionalFeatures.push(newFeature);
        renderAddedFeaturesTable(); // Render windows table
    }

    showModal("Additional feature added to table!", true);

    // Optionally clear the dropdowns after adding
    document.getElementById(`addtnlFeat_${productCategory.toLowerCase()}_${itemNumber}`).value = "";
    document.getElementById(`addtnlFeatVal_${productCategory.toLowerCase()}_${itemNumber}`).innerHTML = '<option value="">Select Value</option>';
    document.getElementById(`xoxo_${productCategory.toLowerCase()}_${itemNumber}`).value = "";
}

    // Function to render the dynamic table
    function renderAddedFeaturesTable() {
        addedWindowsFeaturesTableBody.innerHTML = ''; // Clear existing rows

        if (addedAdditionalFeatures.length === 0) {
            addedWindowsFeaturesTableBody.innerHTML = '<tr><td colspan="8" style="text-align:center;">No additional features added yet.</td></tr>';
            return;
        }

        addedAdditionalFeatures.forEach((feature, index) => {
            const row = addedWindowsFeaturesTableBody.insertRow();
            row.insertCell().textContent = feature["Project Number"];
            row.insertCell().textContent = feature["Product Category"];
            row.insertCell().textContent = feature["Item Number"];
            row.insertCell().textContent = feature["Product Type"];
            row.insertCell().textContent = feature["Additonal Feature"];
            row.insertCell().textContent = feature["Additional Value"];
            row.insertCell().textContent = feature["XOX/XO"];
            const actionCell = row.insertCell();
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'Delete';
            deleteBtn.className = 'delete-btn';
            deleteBtn.addEventListener('click', () => deleteAdditionalFeature(index));
            actionCell.appendChild(deleteBtn);
        });
    }

    // Function to delete an additional feature from the table
    function deleteAdditionalFeature(index) {
        addedAdditionalFeatures.splice(index, 1);
        renderAddedFeaturesTable();
        showModal("Feature deleted.", true);
    }


    windowsSoldInput.addEventListener('input', () => {
      generateDropdowns(windowsDetails, 'window', parseInt(windowsSoldInput.value) || 0, windowOptions);
      // Clear and re-render the added features table if the number of windows changes
      addedAdditionalFeatures = [];
      renderAddedFeaturesTable();
    });
    doorsSoldInput.addEventListener('input', () => {
      generateDropdowns(doorsDetails, 'door', parseInt(doorsSoldInput.value) || 0, doorOptions);
    });
    wallsSoldInput.addEventListener('input', () => {
      generateDropdowns(wallsDetails, 'wall', parseInt(wallsSoldInput.value) || 0, wallOptions);
    });

    // Form submission
document.getElementById('adminForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    const statusMessage = document.getElementById('statusMessage');
    statusMessage.style.color = '#333';
    statusMessage.textContent = 'Submitting... Please wait.';

    const formData = new FormData(this);
    const mainDataScriptURL = 'https://script.google.com/macros/s/AKfycbwpBhqbcChnIPLjzuxsKJ_8wQ0wAjszAK_3HMWrf85PxK1gzUXWNaEplN2nd4vJYDXa7A/exec';

    // Part 1: Submit the main form data
    try {
        const mainResponse = await fetch(mainDataScriptURL, { method: 'POST', body: formData });
        const mainResult = await mainResponse.json();

        if (mainResult.result !== 'success') {
            statusMessage.style.color = 'red';
            statusMessage.textContent = 'Error: ' + (mainResult.message || 'Main submission failed.');
            showModal('Error: ' + (mainResult.message || 'Main submission failed.'), false);
            return; // Stop execution if main submission fails
        }
    } catch (error) {
        statusMessage.style.color = 'red';
        statusMessage.textContent = 'An error occurred during main form submission. Please try again.';
        console.error('Error!', error);
        showModal('An error occurred during main form submission. Please try again.', false);
        return; // Stop execution on network error
    }

    // Part 2: Submit the additional features data (this section is new)
    
    // NEW: Combine both windows and doors feature arrays
    const combinedFeatures = addedAdditionalFeatures.concat(addedAdditionalDoorsFeatures);

    if (combinedFeatures.length > 0) {
        try {
            await fetch(ADDITIONAL_FEATURES_WEB_APP_URL, {
                method: 'POST',
                body: JSON.stringify(combinedFeatures),
                headers: {'Content-Type': 'application/json'},
                mode: 'no-cors' // Use no-cors mode to bypass CORS policy
            });
            showModal('Additional features submission initiated. Please check your Google Sheet to confirm.', true);
        } catch (error) {
            console.error('Error submitting additional features:', error);
            showModal('An error occurred while submitting additional features. Please try again.', false);
        }
    }

    // Final Success Message & Cleanup
    statusMessage.style.color = 'green';
    statusMessage.textContent = 'All data submitted successfully!';
    showModal('✅ All data submitted successfully!', true);

    // Clear the form and dynamic table after both submissions are complete
    this.reset();
    addedAdditionalFeatures = [];
    addedAdditionalDoorsFeatures = []; // NEW: Clear the doors array as well
    renderAddedFeaturesTable();
    renderAddedDoorsFeaturesTable(); // NEW: Render the doors table to clear it

    // Reload the page after a short delay to allow user to read the message
    setTimeout(() => location.reload(), 1500);
});

    // Custom Modal for alerts
    function showModal(message, isSuccess) {
      // Create modal elements
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
      `;

      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        text-align: center;
        max-width: 300px;
        width: 90%;
        font-family: 'Poppins', sans-serif;
        color: ${isSuccess ? '#28a745' : '#dc3545'}; /* Green for success, red for error */
        font-weight: 600;
      `;
      modalContent.textContent = message;

      modal.appendChild(modalContent);
      document.body.appendChild(modal);

      // Fade in the modal
      setTimeout(() => modal.style.opacity = 1, 10);

      // Automatically close after 1.5 seconds
      setTimeout(() => {
        modal.style.opacity = 0;
        setTimeout(() => document.body.removeChild(modal), 300); // Remove after fade out
      }, 1500);
    }

    // === Jump Buttons ===
    let fadeTimeout;
    const topBtn = document.getElementById("jumpTop");
    const bottomBtn = document.getElementById("jumpBottom");

    function showButtons() {
      if (window.scrollY > 300) topBtn.classList.add("show");
      else topBtn.classList.remove("show");

      if (window.innerHeight + window.scrollY < document.body.scrollHeight - 300) bottomBtn.classList.add("show");
      else bottomBtn.classList.remove("show");
    }

    function hideButtons() {
      if (!topBtn.matches(":hover") && !bottomBtn.matches(":hover")) {
        topBtn.classList.remove("show");
        bottomBtn.classList.remove("show");
      }
    }

    window.addEventListener("scroll", function () {
      clearTimeout(fadeTimeout);
      showButtons();
      fadeTimeout = setTimeout(hideButtons, 3000);
    });

    [topBtn, bottomBtn].forEach(btn => {
      btn.addEventListener("mouseenter", () => {
        clearTimeout(fadeTimeout);
        showButtons();
      });
      btn.addEventListener("mouseleave", () => {
        fadeTimeout = setTimeout(hideButtons, 3000);
      });
    });

    topBtn.addEventListener("click", () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    bottomBtn.addEventListener("click", () => {
      window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
    });

    // === Project Number Duplicate Check ===
    const projectNumberInput = document.getElementById("projectNumberInput");
    const projectWarning = document.getElementById("projectWarning");
    const submitBtn = document.querySelector("#adminForm button[type='submit']");

    projectNumberInput.addEventListener("blur", () => {
      const num = projectNumberInput.value.trim();

      // If empty → clear warning and enable submit
      if (!num) {
        projectWarning.style.display = "none";
        projectNumberInput.style.borderColor = "";
        submitBtn.disabled = false;
        submitBtn.style.backgroundColor = "";
        submitBtn.style.cursor = "";
        return;
      }

      const normalizedNum = num.replace(/[^0-9]/g, ""); // keep only digits
      const projectId = "WS-" + normalizedNum.toUpperCase();
      const scriptURL = 'https://script.google.com/macros/s/AKfycbwpBhqbcChnIPLjzuxsKJ_8wQ0wAjszAK_3HMWrf85PxK1gzUXWNaEplN2nd4vJYDXa7A/exec';

      fetch(`${scriptURL}?action=checkProject&projectNumber=${encodeURIComponent(projectId)}`)
        .then(r => r.json())
        .then(data => {
          if (data.exists) {
            projectWarning.textContent = "⚠️ Project already exists!";
            projectWarning.style.display = "block";
            projectNumberInput.style.borderColor = "red";
            submitBtn.disabled = true;
            submitBtn.style.backgroundColor = "#aaa";
            submitBtn.style.cursor = "not-allowed";
          } else {
            projectWarning.style.display = "none";
            projectNumberInput.style.borderColor = "";
            submitBtn.disabled = false;
            submitBtn.style.backgroundColor = "";
            submitBtn.style.cursor = "";
          }
        })
        .catch(err => {
          console.error("Error checking project:", err);
        });
    });

    // === Gather Additional Features Data Function ===
    // This function will gather all data from the dynamically added features table
    function gatherAdditionalFeaturesData() {
        return addedAdditionalFeatures;
    }

    // === Submit Additional Features Button Handler ===
document.getElementById('submitAdditionalFeaturesBtn').addEventListener('click', async function() {
    let alertMessage = "Additional Features Data:\n\n";

    if (addedAdditionalFeatures.length === 0) {
        alertMessage = "No additional features have been added yet.";
        showModal(alertMessage, true);
        return; // Stop execution if no data is present
    } else {
        addedAdditionalFeatures.forEach((item, index) => {
            alertMessage += `Item ${index + 1}:\n`;
            alertMessage += `Project Number: ${item["Project Number"]}\n`;
            alertMessage += `Product Category: ${item["Product Category"]}\n`;
            alertMessage += `Item Number: ${item["Item Number"]}\n`;
            alertMessage += `Product Type: ${item["Product Type"]}\n`;
            alertMessage += `Feature: ${item["Additonal Feature"]}\n`;
            alertMessage += `Value: ${item["Additional Value"]}\n`;
            alertMessage += `XOX/XO: ${item["XOX/XO"]}\n\n`;
        });
    }

    // Part 1: Submit the data to the Apps Script FIRST
    await submitAdditionalFeatures();

    // Part 2: Display the data in a modal AFTER submission
    showModal(alertMessage, true);
});

    // Initialize the additional features table on load
    document.addEventListener('DOMContentLoaded', renderAddedFeaturesTable);

// New button to show collected data and submit to Apps Script
document.getElementById('showFeaturesBtn').addEventListener('click', async function() {
    // Combine both arrays before submission
    const combinedFeatures = addedAdditionalFeatures.concat(addedAdditionalDoorsFeatures);
    let alertMessage = "Additional Features Data:\n\n";

    if (combinedFeatures.length === 0) {
        alertMessage = "No additional features have been added yet.";
        showModal(alertMessage, true);
        return; // Stop execution if no data is present
    } else {
        combinedFeatures.forEach((item, index) => {
            alertMessage += `Item ${index + 1}:\n`;
            alertMessage += `Project Number: ${item["Project Number"]}\n`;
            alertMessage += `Product Category: ${item["Product Category"]}\n`;
            alertMessage += `Item Number: ${item["Item Number"]}\n`;
            alertMessage += `Product Type: ${item["Product Type"]}\n`;
            alertMessage += `Feature: ${item["Additonal Feature"]}\n`;
            alertMessage += `Value: ${item["Additional Value"]}\n`;
            alertMessage += `XOX/XO: ${item["XOX/XO"]}\n\n`;
        });
        showModal(alertMessage, true);
    }

    // Part 2: Submit the data to the Apps Script (using no-cors mode)
    try {
        await fetch(ADDITIONAL_FEATURES_WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify(combinedFeatures),
            headers: {'Content-Type': 'application/json'},
            mode: 'no-cors' // Allows the request to be sent
        });

        // The submission happened, but we cannot check the response in no-cors mode.
        showModal('Additional features submission initiated. Please check your Google Sheet to confirm.', true);
        
    } catch (error) {
        console.error('Error submitting additional features:', error);
        showModal('An error occurred while submitting additional features. Please try again.', false);
    }
});

// New button to show collected doors data and submit to Apps Script
document.getElementById('showDoorsFeaturesBtn').addEventListener('click', async function() {
    let alertMessage = "Doors Additional Features Data:\n\n";

    if (addedAdditionalDoorsFeatures.length === 0) {
        alertMessage = "No doors additional features have been added yet.";
        showModal(alertMessage, true);
        return;
    } else {
        addedAdditionalDoorsFeatures.forEach((item, index) => {
            alertMessage += `Item ${index + 1}:\n`;
            alertMessage += `Project Number: ${item["Project Number"]}\n`;
            alertMessage += `Product Category: ${item["Product Category"]}\n`;
            alertMessage += `Item Number: ${item["Item Number"]}\n`;
            alertMessage += `Product Type: ${item["Product Type"]}\n`;
            alertMessage += `Feature: ${item["Additonal Feature"]}\n`;
            alertMessage += `Value: ${item["Additional Value"]}\n`;
            alertMessage += `XOX/XO: ${item["XOX/XO"]}\n\n`;
        });
        showModal(alertMessage, true);
    }

    try {
        await fetch(ADDITIONAL_FEATURES_WEB_APP_URL, {
            method: 'POST',
            body: JSON.stringify(addedAdditionalDoorsFeatures),
            headers: {'Content-Type': 'application/json'},
            mode: 'no-cors'
        });

        showModal('Doors additional features submission initiated. Please check your Google Sheet to confirm.', true);
        
    } catch (error) {
        console.error('Error submitting doors additional features:', error);
        showModal('An error occurred while submitting doors additional features. Please try again.', false);
    }
});
// Function to render the dynamic table with added doors features
function renderAddedDoorsFeaturesTable() {
    const tableBody = document.getElementById('addedDoorsFeaturesTableBody');
    tableBody.innerHTML = ''; // Clear the table before re-rendering

    addedAdditionalDoorsFeatures.forEach((feature, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${feature["Project Number"]}</td>
            <td>${feature["Product Category"]}</td>
            <td>${feature["Item Number"]}</td>
            <td>${feature["Product Type"]}</td>
            <td>${feature["Additonal Feature"]}</td>
            <td>${feature["Additional Value"]}</td>
            <td>${feature["XOX/XO"]}</td>
            <td><button class="remove-feature-btn" data-index="${index}" data-product-category="${feature['Product Category']}">Remove</button></td>
        `;
        tableBody.appendChild(row);
    });
}
  </script>
</body>
</html>
