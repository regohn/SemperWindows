<!---
LOGS
upload for product types worked

-->


<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Installer Details</title>
  <button type="button" onclick="fillFormForTesting()" id="fillFormsBtn">Fill Forms</button>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; background: #fafafa; }
    h2 { text-align: center; }

    .header-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 20px; background-color: #f2f2f7; border-bottom: 1px solid #e5e5ea; margin-bottom: 1rem;
    }
    .logoff-link {
      color: #007aff; text-decoration: none; font-weight: 600; font-size: 14px;
      padding: 8px 12px; border: 1px solid #007aff; border-radius: 6px;
      transition: background-color 0.2s,color 0.2s;
    }
    .logoff-link:hover { background-color: #007aff; color: #fff; }

    .add-btn {
      font-size: .85rem; padding: 6px 14px; border-radius: 6px;
      border: 1px solid #007aff; background: #007aff; color: #fff; text-decoration: none;
      transition: background .2s;
    }
    .add-btn:hover { background: #005ecb; }

    .tabs { display: flex; justify-content: center; margin-bottom: 1rem; gap: 6px; flex-wrap: wrap; }
    .tab { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; background: #f4f4f4; }
    .tab.active { background: #4e54c8; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .tab.summary-invalid { background: #e74c3c; color: #fff; }
    .tab.summary-valid { background: #27ae60; color: #fff; }
    .tab.project-completed { background: #6c757d; color: #fff; cursor: default; } /* Style for completed project tab */


    .form-section {
      max-width: 520px; margin: 20px auto; padding: 18px;
      border-radius: 14px; background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,.05); border: 1px solid #eee;
    }
    .form-section h4 {
      margin: 0 0 10px; font-size: 1.05rem; font-weight: 600; color: #333;
      padding-bottom: 8px; border-bottom: 1px solid #eee;
    }
    .form-group { margin-bottom: 12px; }
    .form-group label { display:block; font-weight:500; font-size: 14px; color:#333; margin-bottom: 4px; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
      background: #f9f9f9; font-size: 14px; box-sizing: border-box; transition: border-color .2s;
      font-family: inherit;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color:#007aff; outline: none; background: #fff; }
    .form-group textarea { resize: vertical; min-height: 80px; }

    .submit-btn {
      background: #007aff; color: #fff; padding: 10px 14px; border: 0; border-radius: 8px;
      font-size: 14px; cursor: pointer; width: 100%; transition: background-color .2s;
    }
    .submit-btn:hover:not(:disabled) { background: #005ecb; }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; } /* Added disabled style */

    #masterStatus { display:inline-block; margin-top: 10px; font-size: 14px; }
    #projectCompletionMessage {
        text-align: center;
        color: #e74c3c; /* Red color for completion message */
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 1.1em;
    }

    /* Styles for side-by-side inputs and button */
    .door-dimensions-group { /* Renamed from .dimension-search-group to match user's snippet */
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    .door-dimensions-group .form-group { /* Renamed from .dimension-search-group to match user's snippet */
        flex-grow: 1; /* Distribute space evenly */
        margin-bottom: 0;
    }

    .door-dimensions-group button { /* Renamed from .dimension-search-group to match user's snippet */
      padding: 10px 15px;
      border: 1px solid #007aff;
      background-color: #007aff;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
      height: 38px; /* Match height of inputs */
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap; /* Prevent button text from wrapping */
    }
    .door-dimensions-group button:hover { /* Renamed from .dimension-search-group to match user's snippet */
      background-color: #005ecb;
    }

    .door-lookup-status { /* New style for the local status message */
        font-size: 0.9em;
        margin-top: 5px;
        margin-bottom: 10px;
        text-align: center;
        color: #555; /* Neutral color */
        min-height: 1.5em; /* Reserve space to avoid layout shifts */
    }
    .door-lookup-status.error { color: #e74c3c; }
    .door-lookup-status.success { color: #27ae60; }
    .door-lookup-status.warning { color: #f39c12; }

    /* New style for smaller font in summary tab */
    .summary-item-list {
        font-size: 0.85em; /* Approximately 10pt */
    }
    /* New style for red text for empty values in summary tab */
    .summary-empty-value {
        color: #e74c3c; /* Red color for empty/no files */
        font-weight: bold;
    }
    
    /* Styles for the collapsible summary menu */
    #collapsibleSummaryContainer {
        max-width: 520px;
        margin: 20px auto;
        padding: 18px;
        border-radius: 14px;
        background: #fff;
        box-shadow: 0 4px 12px rgba(0,0,0,.05);
        border: 1px solid #eee;
        display: none; /* Initially hidden */
    }
    .summary-details {
        margin-top: 10px;
        border-bottom: 1px solid #eee;
    }
    .summary-details:last-of-type {
        border-bottom: none;
    }
    .summary-details summary {
        cursor: pointer;
        font-weight: bold;
        padding: 10px;
        background-color: #f2f2f7;
        border-radius: 8px;
        transition: background-color 0.2s;
    }
    .summary-details summary:hover {
        background-color: #e5e5ea;
    }
    .summary-content {
        padding: 10px;
        margin-top: 5px;
        background-color: #fafafa;
        border-radius: 8px;
        border: 1px solid #eee;
    }
    .summary-content p {
        margin: 0;
        line-height: 1.5;
        font-size: 0.9em;
    }
    .summary-content p span.label {
        font-weight: bold;
        color: #555;
    }
    .summary-content p span.value.empty {
        color: #e74c3c;
        font-style: italic;
    }

    @media (max-width: 768px) {
      body { padding: .5rem; }
      .tab { flex: 1 1 45%; text-align: center; }
      .form-section { max-width: 100%; margin: 12px 0; padding: 14px; }
      .door-dimensions-group { /* Renamed from .dimension-search-group to match user's snippet */
        flex-direction: column; /* Stack vertically on small screens */
        align-items: stretch;
      }
      .door-dimensions-group button { /* Renamed from .dimension-search-group to match user's snippet */
        width: 100%; /* Full width button on small screens */
      }
    }
    @media (max-width: 480px) { .tab { flex: 1 1 100%; } }
.info-icon {
  margin-left: 8px;
  font-size: 1.1em;
  color: #007aff;
  cursor: pointer;
}
.info-icon:hover {
  color: #005ecb;
}
.details-container {
  display: none;
  background-color: #f2f2f7;
  padding: 10px;
  margin-top: 10px;
  border-radius: 8px;
  font-size: 0.9em;
  border: 1px solid #e5e5ea;
}
.details-container.active {
  display: block;
}   
[id$="_thumbs"] img {
  max-width: 120px;
  max-height: 100px;
  width: auto;
  height: auto;
  display: inline-block;
  border: 1px solid #ccc;
  border-radius: 4px;
  margin: 4px;
}

.copy-link {
  display: inline-block;
  background: #007aff;
  color: #fff !important;
  padding: 6px 12px;
  border-radius: 6px;
  text-decoration: none;
  font-size: 0.9em;
}
.copy-link:hover {
  background: #005ecb;
}
#scrollControls {
  position: fixed;
  bottom: 20px;
  right: 20px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 9999;
}

.scroll-btn {
  width: 40px;
  height: 40px;
  border: none;
  border-radius: 50%;
  background: #007aff;
  color: white;
  font-size: 20px;
  cursor: pointer;
  box-shadow: 0 2px 6px rgba(0,0,0,0.2);
  opacity: 0.8;
  transition: background 0.2s, opacity 0.2s;
}

.scroll-btn:hover {
  background: #005ecb;
  opacity: 1;
}



  </style>
</head>
<body>
  <div class="header-bar">
    <span>Welcome, <span id="userName"></span>!</span>
    <a href="#" class="logoff-link" onclick="logoff()">Logoff</a>
  </div>

  <div style="display:flex; justify-content:center; margin-bottom:1rem; gap: 10px;">
    <a id="projectSummaryLink" class="add-btn">Project Summary</a>
    <button type="button" id="toggleSummaryBtn" class="add-btn" hidden>View Submitted Data</button>
    
  </div>

  <h2>Installer Details</h2>
  <div id="projectCompletionMessage" aria-live="polite"></div> <div id="projectInfo" style="text-align:center; margin-bottom: .5rem;"></div>
  <div id="salesInfo" style="text-align:center; margin-bottom: 1rem; font-weight: bold;"></div>
  <div id="imgWarning" style="text-align:center; margin-bottom: 1rem; font-weight: bold;"></div>

  <div id="collapsibleSummaryContainer"></div>

  <div class="tabs">
    <div class="tab active" onclick="showTab('windows')">Windows Sold</div>
    <div class="tab" onclick="showTab('doors')">Doors Sold</div>
    <div class="tab" onclick="showTab('glass')">Glass Walls Sold</div>
    <div id="summaryTabBtn" class="tab summary-invalid" onclick="showTab('summary')">Inputs Incomplete</div>
  </div>

  <div style="max-width:520px; margin: 10px auto; text-align:center;">
    <button type="button" onclick="saveDraftLocally()" class="add-btn">Save Draft</button>
    <button type="button" onclick="loadDraftLocally()" class="add-btn">Load Draft</button>
    <button type="button" onclick="clearDraftLocally()" class="add-btn" style="background:#e74c3c; border-color:#e74c3c;">Clear Draft</button>
  </div>
  
    <div id="draftMessage" style="display:none; text-align:center; margin:10px auto; padding:5px; max-width:520px">
    </div>
    <div id="saveMessage" style="display:none; text-align:center; margin:10px auto; padding:5px; max-width:520px">
      <span id="saveText"></span>
    </div>    

    

  <div id="windows" class="tab-content active"></div>
  <div id="doors" class="tab-content"></div>
  <div id="glass" class="tab-content"></div>
  <div id="summary" class="tab-content"></div>

  <div style="max-width:520px; margin: 20px auto; text-align:center;">
    <input type="hidden" id="projectNumberHidden" name="projectNumber" />
    <button id="masterSubmitBtn" class="submit-btn"   onclick="document.getElementById('masterStatus').textContent='Please wait...prepairing to submit.'" >Submit All</button>
    <br>
    <div id="masterStatus" aria-live="polite"></div>
  </div>

<div id="scrollControls">
  <button id="scrollTopBtn" class="scroll-btn" title="Scroll to top">⬆</button>
  <button id="scrollBottomBtn" class="scroll-btn" title="Scroll to bottom">⬇</button>
</div>

<script>

  document.addEventListener("DOMContentLoaded", () => {
  const scrollTopBtn = document.getElementById("scrollTopBtn");
  const scrollBottomBtn = document.getElementById("scrollBottomBtn");

  scrollTopBtn.addEventListener("click", () => {
    window.scrollTo({ top: 0, behavior: "smooth" });
  });

  scrollBottomBtn.addEventListener("click", () => {
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  });

  window.addEventListener("scroll", () => {
    scrollTopBtn.style.display = window.scrollY > 200 ? "block" : "none";
    scrollBottomBtn.style.display =
      window.innerHeight + window.scrollY < document.body.scrollHeight - 200
        ? "block"
        : "none";
  });

  scrollTopBtn.style.display = "none";
  scrollBottomBtn.style.display = "none";
});


  const DB_NAME = 'InstallerDrafts_v3';
const STORE_NAME = 'drafts';

function debugLog(...args){ console.log('[Drafts]', ...args); }
  // URL for the Google Apps Script that fetches project details and product types
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxSDvmdLSCpyq-tdRiJlUm4jItjAfxJbOZ018vwHRzlENBMSy43nxjgoHtAtiwFSetB/exec';
  // URL for submitting data
  const UPLOAD_URL = 'https://script.google.com/macros/s/AKfycbz8Xt95yliau1oJBfj1qm7ISrR6RwmkOy2d3mGBZiTNSwQIprry7wQcsZnt5htkLmPKQQ/exec';
    //  original const UPLOAD_URL = 'https://script.google.com/macros/s/AKfycbw44osy47azJbKBm3s4qcfkVncpkdT7buZPjJxk_3zuUPsVx88neupQIDSVUWsFYAZZ/exec';
    // Sandbox https://script.google.com/macros/s/AKfycbxIuKfLTOd1_b2n3Ix7zgABeoqLhOXozm9DXm3ze-2GHDQbxeDJhh2WgErr2ddfZJHByA/exec
    //sandbox1 https://script.google.com/macros/s/AKfycbz8Xt95yliau1oJBfj1qm7ISrR6RwmkOy2d3mGBZiTNSwQIprry7wQcsZnt5htkLmPKQQ/exec

  // URL for checking data (not used in this specific fix, but kept for context)
  const CHECK_URL  = 'https://script.google.com/macros/s/AKfycbzBqeJFJejvhiB_ChmM71sqNZnvvz_PtXvmRhRF_3Nv0l42Orwjt55OffxiIoGZVxKBMw/exec';
  // New URL for the Google Apps Script to perform the door dimension lookup
  const LOOKUP_URL = 'https://script.google.com/macros/s/AKfycbzyvxUGOW7WpUt_37JEcVBGSA8zogDTvz00banbuSJgy22NbYWmLCPvdMx8e47MTohrnw/exec'; // This should be updated with the new deployment URL for the new script

  // Mapping of container IDs to human-readable tab names
  const TAB_MAP = { windows: 'Windows Sold', doors: 'Doors Sold', glass: 'Glass Walls Sold' };

  let isProjectComplete = false; // Global flag for project completion status
  let projectData = []; // Global variable to store all project data

  /**
   * Logs the user off by clearing session storage and redirecting to the login page.
   */
function logoff() {
    sessionStorage.removeItem('installer');
    sessionStorage.removeItem('role');
    // FIX: Use a relative path for local file redirection
    window.location.href = 'windowsloginpage.html';
}

  // Immediately-invoked function to initialize the header with user information and project summary link
  (function initHeader(){
    const rawUserName = sessionStorage.getItem('installer');
    const displayUserName = rawUserName ? rawUserName.split('@')[0] : 'Guest';
    document.getElementById('userName').textContent = displayUserName;

    const role = sessionStorage.getItem('role');
    const projectSummaryLink = document.getElementById('projectSummaryLink');
    // Set the correct link for project summary based on user role
    projectSummaryLink.href = (role && role.toLowerCase() === 'admin')
      ? 'adminsprojectsummary.html' : 'projectsummary.html';
  })();

  // Retrieve project number and installer name from session storage
  const projectNumber = sessionStorage.getItem('selectedProject');
  const installerName = sessionStorage.getItem('installer');
  // Set the hidden field value for form submission
  document.getElementById('projectNumberHidden').value = projectNumber;  

  // Log sessionStorage values
  console.log("Project Number from sessionStorage:", projectNumber);
  console.log("Installer Name from sessionStorage:", installerName);

  // If project number or installer name is missing, redirect to login page
  if (!projectNumber || !installerName) {
    // FIX: Use an absolute path for redirection
    window.location.href = window.location.origin + '/windowsloginpage.html';
  }

  // Display current project and installer information
  document.getElementById('projectInfo').innerText =
    `Project: ${projectNumber} | Installer: ${installerName}`;

  // Fetch project details and product types from the Google Apps Script
  fetch(scriptURL + '?projectNumber=' + encodeURIComponent(projectNumber))
    .then(res => res.json())
    .then(data => {
      // Log the full data response
      console.log("Raw data from scriptURL:", data);

      if (data && data.length > 0) {
        projectData = data; // Store all data globally
        const row = data[0];
        console.log("First row of data (from scriptURL):", row);
        // Helper function to safely get data, handling potential undefined or trimmed keys
        const get = (key) => (row[key] ?? row[key?.trim?.()] ?? '');
        const windowsCount = parseInt(get('Windows Sold')) || 0;
        const doorsCount   = parseInt(get('Doors Sold'))   || 0;
        const glassCount   = parseInt(get('Glass Walls Sold')) || 0;

        // Log the parsed counts
        console.log(`Counts: Windows=${windowsCount}, Doors=${doorsCount}, Glass Walls=${glassCount}`);

        // Display the counts of items sold
        document.getElementById('salesInfo').textContent =
          `Windows Sold: ${windowsCount} | Doors Sold: ${doorsCount} | Glass Walls Sold: ${glassCount}`;

        // Create forms for each category, passing the specific product types for each item
        createForms('windows', windowsCount, 'Windows', row.WindowTypes || []);
        createForms('doors', doorsCount, 'Doors', row.DoorTypes || []);
        createForms('glass', glassCount, 'Glass Walls', row.GlassTypes || []);

        // Now generate the summary tree
        generateSubmittedSummary();

        // Validate all forms and update the summary tab
        validateAll();
        updateSummary();

        // Check project status and update UI accordingly
        const projectStatus = get('Project Status');
        if (projectStatus && projectStatus.toLowerCase() === 'complete') {
          isProjectComplete = true; // Set global flag
          //document.getElementById('projectCompletionMessage').textContent = 'This project has been completed.';
          //document.getElementById('masterSubmitBtn').disabled = true;
          // Update the summary tab button to reflect completion
          const summaryTabBtn = document.getElementById('summaryTabBtn');
          summaryTabBtn.classList.remove("summary-invalid", "summary-valid");
          summaryTabBtn.classList.add("project-completed");
          summaryTabBtn.textContent = "Project Completed";
          //disableAllUserInputs(); // Disable all editable fields
        }

        // Attach event listener for door search buttons after forms are created
        attachDoorSearchListeners();

      } else {
        console.log("No data or empty data array returned from scriptURL for project:", projectNumber);
        document.getElementById('salesInfo').textContent = 'No sales data found for this project.';
      }
    })
    .catch(err => {
      console.error("Error retrieving sales data from scriptURL:", err);
      document.getElementById('salesInfo').textContent = 'Error retrieving sales data.';
    });

/**
 * Creates the form sections for a given category (windows, doors, or glass walls).
 * @param {string} containerId - The ID of the HTML container for the forms (e.g., 'windows').
 * @param {number} count - The number of forms to create for this category.
 * @param {string} label - The human-readable label for the category (e.g., 'Windows').
 * @param {string[]} productTypesArray - An array of product types for the specific items in this category.
 * @param {string[]} productDetailsArray - An array of full product details for the specific items.
 */
/**
 * Creates the form sections for a given category (windows, doors, or glass walls).
 * @param {string} containerId - The ID of the HTML container for the forms (e.g., 'windows').
 * @param {number} count - The number of forms to create for this category.
 * @param {string} label - The human-readable label for the category (e.g., 'Windows').
 * @param {string[]} productTypesArray - An array of product types for the specific items in this category.
 * @param {string[]} productDetailsArray - An array of full product details for the specific items.
 */
function createForms(containerId, count, label, productTypesArray = [], productDetailsArray = []) {
  const container = document.getElementById(containerId);
  if (!container) return;
  if (count === 0) {
    container.innerHTML = `<p>No ${label} sold.</p>`;
    return;
  }
  let html = '';
  // Generate the new common fields once at the top of each tab
  html += `
    <div class="form-section" data-container="${containerId}" data-index="0">
      <h4>General ${label} Information</h4>
      ${buildFields(containerId, 0, '', 'common')}
    </div>
  `;
    html += `
    <div style="text-align:center; margin:8px 0;">
      <a href="#" class="copy-link" onclick="copyAllFromFirst('${containerId}'); return false;">
        Copy ${label} #1 to All
      </a>
      <div id="copyStatus_${containerId}" style="margin-top:6px; font-size:0.9em; color:#555;"></div>
      
    </div>
  `;

  // Generate the forms for each individual item, starting from index 1
  for (let i = 1; i <= count; i++) {
    // Get the specific product type for this item number (idx)
    const itemProductType = productTypesArray[i - 1] || '';
    const itemDetails = productDetailsArray[i - 1] || '';
    html += `
      <div class="form-section" data-container="${containerId}" data-index="${i}" data-product-type="${itemProductType}" data-product-details="${itemDetails}">
        <h4>${label} #${i}
          <span class="info-icon" onclick="expandInfo(this, '${containerId}', ${i})">&#9432;</span> </h4>
        <div id="details_${containerId}_${i}" class="details-container"></div> ${buildFields(containerId, i, itemProductType)}
      </div>
    `;
  }
  container.innerHTML = html;
}

  /**
   * Builds the HTML fields for a single form section based on its category.
   * @param {string} containerId - The ID of the parent container (e.g., 'windows').
   * @param {number} idx - The index of the current item (e.g., 1 for Window #1).
   * @param {string} itemProductType - The specific product type for this item, to be displayed in the read-only field.
   * @returns {string} The HTML string for the form fields.
   */

function buildFields(containerId, idx, itemProductType = '', purpose = '') {
  const readOnly = v => `value="${v}" readonly`;
  // Helper functions for creating fields
  const text = (label, name, inputType = 'text', extra = '') => {
    let idName = name.replace(/\s/g, '').replace(/_/g, '');
    let fieldName;
    if (purpose === 'common') {
      fieldName = `${containerId.replace('s','')}_${idName}_common`;
      idName = fieldName;
    } else {
      if (containerId === 'windows') {
        fieldName = `window_${idName}_${idx}`;
        idName = fieldName;
      } else if (containerId === 'doors') {
        fieldName = `door_${idName}_${idx}`;
        idName = fieldName;
      } else if (containerId === 'glass') {
        fieldName = `glasswall_${idName}_${idx}`;
        idName = fieldName;
      }
    }
    return `<div class="form-group"><label>${label}</label><input type="${inputType}" name="${fieldName}" id="${idName}" ${extra}></div>`;
  };
  const select = (label, name, options, extra = '') => {
    let idName = name.replace(/\s/g, '').replace(/_/g, '');
    let fieldName;
    if (purpose === 'common') {
      fieldName = `${containerId.replace('s','')}_${idName}_common`;
      idName = fieldName;
    } else {
      if (containerId === 'windows') {
        fieldName = `window_${idName}_${idx}`;
        idName = fieldName;
      } else if (containerId === 'doors') {
        fieldName = `door_${idName}_${idx}`;
        idName = fieldName;
      } else if (containerId === 'glass') {
        fieldName = `glasswall_${idName}_${idx}`;
        idName = fieldName;
      }
    }
    return `<div class="form-group"><label>${label}</label><select name="${fieldName}" id="${idName}" ${extra}>${options.map(o => `<option value="${o.value}" ${o.value === "" ? "disabled selected" : ""}>${o.text}</option>`).join('')}</select></div>`;
  };
  const fileMulti = (label, name) => {
    let idName = name.replace(/\s/g, '').replace(/_/g, '');
    let fieldName;
    if (purpose === 'common') {
      fieldName = `${containerId.replace('s','')}_${idName}_common`;
      idName = fieldName;
    } else {
      if (containerId === 'windows') {
        fieldName = `window_${idName}_${idx}`;
        idName = fieldName;
      } else if (containerId === 'doors') {
        fieldName = `door_${idName}_${idx}`;
        idName = fieldName;
      } else if (containerId === 'glass') {
        fieldName = `glasswall_${idName}_${idx}`;
        idName = fieldName;
      }
    }
    const showNote = (name === "Interior_Pictures_URL" || name === "Exterior_Pictures_URL");
    const note = showNote
      ? `<small style="display:block; margin-top:4px; color:#666; font-size:12px;">
           Choose all related files when uploading
         </small>`
      : "";
    return `<div class="form-group">
              <label>${label.replaceAll('_',' ')}</label>
              <input type="file" name="${fieldName}" id="${idName}" accept="image/*" multiple>
              ${note}
            </div>`;
  };
  // New common fields section
  if (purpose === 'common') {
    const exteriorWallTypeOptions = [
      {value: "", text: "Select..."},
      {value: "Stucco", text: "Stucco"},
      {value: "Siding", text: "Siding"},
      {value: "Other", text: "Other"}
    ];
    const interiorWallTypeOptions = [
      {value: "", text: "Select..."},
      {value: "Drywall", text: "Drywall"},
      {value: "Plaster", text: "Plaster"},
      {value: "Tile", text: "Tile"},
      {value: "Other", text: "Other"}
    ];
    return `
      ${text('Existing Frame Type','Existing Frame Type')}
      ${select('Interior Wall Type','Interior Wall Type', interiorWallTypeOptions)}
      ${select('Exterior Wall Type','Exterior Wall Type', exteriorWallTypeOptions)}
      ${fileMulti('Exterior_Pictures_URL', 'Exterior_Pictures_URL')}
    `;
  }
  // Original logic for each item type
  if (containerId === 'windows') {
    const alternativeWindowOptions = [
      {value: "", text: "Select..."},
      {value: "Single Hung", text: "Single Hung - SH"},
      {value: "Slider Window", text: "Slider Window - SL"},
      {value: "End Vent Slider", text: "End Vent Slider - EVSL"},
      {value: "Picture Window", text: "Picture Window - PW"},
      {value: "Casement", text: "Casement - CA"},
      {value: "Casement Picture", text: "Casement Picture"},
      {value: "Casement & Picture", text: "Casement & Picture"},
      {value: "Casement-Picture", text: "Casement-Picture"},
      {value: "Casement-Casement", text: "Casement-Casement"},
      {value: "Single Awning", text: "Single Awning - SA"},
      {value: "Picture over Awning", text: "Picture over Awning"},
      {value: "Trap Top Single", text: "Trap Top Single - TT"},
      {value: "Arch Top Single", text: "Arch Top Single - AT"},
      {value: "Custom Shapes: (Specify in Notes)", text: "Custom Shapes: (Specify in Notes)"}
    ];
    return `
      ${text('Project Number','Project Number', 'text', readOnly(projectNumber))}
      ${text('Installer Name','Installer Name', 'text', readOnly(installerName))}
      ${text('Window Number','Window Number', 'text', readOnly(idx))}
      ${text('Window Location','Window Location')}
      ${text('Width (Inches)','Width', 'number')}
      ${text('Height (Inches)','Height', 'number')}
      ${fileMulti('Interior_Pictures_URL','Interior_Pictures_URL')}
      <div class="form-group">
        <label>Notes</label>
        <textarea name="Notes" id="window_Notes_${idx}"></textarea>
      </div>
      <div class="form-group">
        <label>Alternative Window Recommendation</label>
        <select name="Alternative Window Recommendation" id="window_AlternativeWindowRecommendation_${idx}">
          ${alternativeWindowOptions.map(o => `<option value="${o.value}">${o.text}</option>`).join('')}
        </select>
      </div>
      ${text('Window Type Sold','Window Type Sold', 'text', readOnly(itemProductType))}
    `;
  }
  if (containerId === 'doors') {
    return `
      ${text('Project Number','Project Number', 'text', readOnly(projectNumber))}
      ${text('Installer Name','Installer Name', 'text', readOnly(installerName))}
      ${text('Door Number','Door Number', 'text', readOnly(idx))}
      ${text('Door Location','Door Location')}
      <div class="door-dimensions-group">
        <div class="form-group">
          <label>Door Dimension Width (Inches)</label>
          <input type="text" name="Width" id="door_doorWidth_${idx}" />
        </div>
        <div class="form-group">
          <label>Door Dimension Height (Inches)</label>
          <input type="text" name="Height" id="door_doorHeight_${idx}" />
        </div>
        <button type="button" class="door-search-btn" data-door-index="${idx}">Search</button>
      </div>
      <div id="doorLookupStatus_${idx}" class="door-lookup-status" aria-live="polite"></div>
      ${fileMulti('Interior_Pictures_URL','Interior_Pictures_URL')}
      <div class="form-group">
        <label>Notes</label>
        <textarea name="Notes" id="door_Notes_${idx}"></textarea>
      </div>
      ${text('Alternative Door Recommendation','Alternative Door Recommendation', 'text', readOnly(''))}
      ${text('Door Type Sold','Door Type Sold', 'text', readOnly(itemProductType))}
      `;
  }
  if (containerId === 'glass') {
    return `
      ${text('Project Number','Project Number', 'text', readOnly(projectNumber))}
      ${text('Installer Name','Installer Name', 'text', readOnly(installerName))}
      ${text('Glass Number','Glass Number', 'text', readOnly(idx))}
      ${text('Glass Location','Glass Location')}
      ${text('Height (Inches)','Height (Inches)', 'number')}
      ${text('Width (Inches)','Width (Inches)', 'number')}
      ${fileMulti('Interior_Pictures_URL','Interior_Pictures_URL')}
      <div class="form-group">
        <label>Notes</label>
        <textarea name="Notes" id="glasswall_Notes_${idx}"></textarea>
      </div>
      ${text('Alternative Glass Recommendation','Alternative Glass Recommendation')}
      ${text('Glass Type Sold','Glass Type Sold', 'text', readOnly(itemProductType))}
      `;
  }
}

/**
 * Generates the collapsible summary tree from the fetched data and displays it.
 */
function generateSubmittedSummary() {
    const container = document.getElementById('collapsibleSummaryContainer');
    let html = '';

    const windowsData = projectData.filter(item => item['Window Number'] !== undefined && item['Window Number'] !== null && item['Window Number'] !== '');
    const doorsData = projectData.filter(item => item['Door Number'] !== undefined && item['Door Number'] !== null && item['Door Number'] !== '');
    const glassData = projectData.filter(item => item['Glass Number'] !== undefined && item['Glass Number'] !== null && item['Glass Number'] !== '');

    const sections = [
        { title: 'Windows Submitted', data: windowsData },
        { title: 'Doors Submitted', data: doorsData },
        { title: 'Glass Walls Submitted', data: glassData }
    ];

    sections.forEach(section => {
        if (section.data.length > 0) {
            html += `<div class="summary-section"><h4>${section.title}</h4>`;
            section.data.forEach(item => {
                const itemNumber = item['Window Number'] || item['Door Number'] || item['Glass Number'];
                const itemType = (item['Window Number'] ? 'Window' : (item['Door Number'] ? 'Door' : 'Glass Wall'));
                html += `<details class="summary-details"><summary>${itemType} #${itemNumber}</summary><div class="summary-content">`;
                
                for (const key in item) {
                    if (item.hasOwnProperty(key)) {
                        const value = item[key] !== null && item[key] !== undefined && item[key] !== '' ? item[key] : '<i>empty</i>';
                        const isEmpty = value === '<i>empty</i>';
                        html += `<p><span class="label">${key.replace(/_/g, ' ')}:</span> <span class="value ${isEmpty ? 'empty' : ''}">${value}</span></p>`;
                    }
                }
                html += `</div></details>`;
            });
            html += `</div>`;
        }
    });

    container.innerHTML = html;
}

  /**
   * Toggles the visibility of the collapsible summary container.
   */
  document.getElementById('toggleSummaryBtn').addEventListener('click', () => {
      const container = document.getElementById('collapsibleSummaryContainer');
      const button = document.getElementById('toggleSummaryBtn');
      if (container.style.display === 'none' || container.style.display === '') {
          container.style.display = 'block';
          button.textContent = 'Hide Submitted Data';
      } else {
          container.style.display = 'none';
          button.textContent = 'View Submitted Data';
      }
  });


  // Helper function to check if a string is numeric (Updated to be more robust)
  const isNumeric = (val) => {
    if (val === null || val === undefined) return false;
    const str = String(val).trim(); // Convert to string and trim
    return str !== '' && !isNaN(Number(str));
  };

  /**
   * Attaches delegated event listeners for door search buttons.
   */
  function attachDoorSearchListeners() {
      const doorsContainer = document.getElementById('doors');
      if (doorsContainer && !doorsContainer.dataset.listenersAttached) { // Prevent attaching multiple times
          doorsContainer.addEventListener('click', (event) => {
              if (event.target.classList.contains('door-search-btn')) {
                  if (isProjectComplete) { // Use the global flag
                      const masterStatusEl = document.getElementById('masterStatus');
                      masterStatusEl.textContent = 'Project is completed, no further actions allowed.';
                      //return;
                  }
                  const doorIndex = parseInt(event.target.dataset.doorIndex, 10);
                  if (!isNaN(doorIndex)) {
                      lookupDoorRecommendation(doorIndex);
                  }
              }
          });
          doorsContainer.dataset.listenersAttached = 'true'; // Mark as attached
          console.log('[DEBUG] Door search event listener attached to #doors container.');
      }
  }


  /**
   * Performs a lookup for door recommendations based on provided dimensions and door type.
   * @param {number} doorIndex - The index of the door form section.
   */
  async function lookupDoorRecommendation(doorIndex) {
    console.log(`[DEBUG] lookupDoorRecommendation called for doorIndex: ${doorIndex}`);

    const widthInput = document.getElementById(`door_doorWidth_${doorIndex}`);
    const heightInput = document.getElementById(`door_doorHeight_${doorIndex}`);
    const doorTypeSoldInput = document.getElementById(`door_DoorTypeSold_${doorIndex}`); // Get Door Type Sold
    const altDoorRecInput = document.getElementById(`door_AlternativeDoorRecommendation_${doorIndex}`);
    const doorLookupStatusEl = document.getElementById(`doorLookupStatus_${doorIndex}`);

    // Clear previous status and recommendation
    doorLookupStatusEl.textContent = '';
    doorLookupStatusEl.className = 'door-lookup-status'; // Reset classes
    if (altDoorRecInput) altDoorRecInput.value = ''; // Clear recommendation field

    const width = widthInput ? widthInput.value.trim() : '';
    const height = heightInput ? heightInput.value.trim() : '';
    const doorTypeSold = doorTypeSoldInput ? doorTypeSoldInput.value.trim() : ''; // Get value

    console.log(`[DEBUG] lookupDoorRecommendation: Retrieved width value: '${width}'`);
    console.log(`[DEBUG] lookupDoorRecommendation: Retrieved height value: '${height}'`);
    console.log(`[DEBUG] lookupDoorRecommendation: Retrieved doorTypeSold value: '${doorTypeSold}'`);

    if (!isNumeric(width) || !isNumeric(height)) {
      doorLookupStatusEl.textContent = '❌ Please enter valid numeric values for Width and Height.';
      doorLookupStatusEl.classList.add('error');
      console.error(`[DEBUG] Validation failed for width: '${width}' or height: '${height}'`);
      return;
    }
    // New validation for doorTypeSold
    if (doorTypeSold === '') {
      doorLookupStatusEl.textContent = '❌ "Door Type Sold" cannot be empty for lookup.';
      doorLookupStatusEl.classList.add('error');
      console.error(`[DEBUG] Validation failed: Door Type Sold is empty.`);
      return;
    }


    doorLookupStatusEl.textContent = `Searching for door dimensions ${width} x ${height} and type "${doorTypeSold}"...`;
    doorLookupStatusEl.classList.add('warning');
    if (altDoorRecInput) altDoorRecInput.value = 'Searching...';

    await new Promise(resolve => setTimeout(resolve, 300)); // 300ms delay

    try {
      // Include doorTypeSold in the query parameters
      const response = await fetch(`${LOOKUP_URL}?width=${encodeURIComponent(width)}&height=${encodeURIComponent(height)}&doorTypeSold=${encodeURIComponent(doorTypeSold)}`);
      const data = await response.json();

      if (data && data.recommendation && data.recommendation !== "Not Found") {
        if (altDoorRecInput) altDoorRecInput.value = data.recommendation;
        doorLookupStatusEl.textContent = `✅ Door recommendation found for ${width} x ${height}, type "${doorTypeSold}".`;
        doorLookupStatusEl.classList.remove('warning');
        doorLookupStatusEl.classList.add('success');
      } else {
        if (altDoorRecInput) altDoorRecInput.value = 'Not Found';
        doorLookupStatusEl.textContent = `⚠️ No door recommendation found for dimensions ${width} x ${height}, type "${doorTypeSold}".`;
        doorLookupStatusEl.classList.remove('warning');
        doorLookupStatusEl.classList.add('warning');
      }
    } catch (error) {
      console.error('[DEBUG] Error during door recommendation lookup:', error);
      if (altDoorRecInput) altDoorRecInput.value = 'Error';
      doorLookupStatusEl.textContent = `❌ Error fetching door recommendation for ${width} x ${height}, type "${doorTypeSold}".`;
      doorLookupStatusEl.classList.remove('warning');
      doorLookupStatusEl.classList.add('error');
    }
  }


  /**
   * Validates all form sections to ensure required fields are filled and numeric fields are valid.
   * @returns {boolean} True if all forms are valid, false otherwise.
   */
  function validateAll() {
    const allSections = document.querySelectorAll('#windows .form-section, #doors .form-section, #glass .form-section');
    if (allSections.length === 0) {
      //document.getElementById('masterSubmitBtn').disabled = true;
      return false;
    }
    let valid = true;

    allSections.forEach(section => {
      // Inputs to validate: all text inputs, selects, textareas that are NOT readonly
      const inputs = section.querySelectorAll('input[type="text"]:not([readonly]), input[type="number"]:not([readonly]), select:not([readonly]), textarea:not([readonly])');
      for (let input of inputs) {
        // Exclude the 'DoorLookupWidth' and 'DoorLookupHeight' from mandatory empty check,
        // but ensure other required fields (not read-only) are not empty.
        // The new "Width" and "Height" in the doors section (id="doorWidth/Height") are also required.
        const isDoorLookupDimension = (input.id && (input.id.startsWith('doorWidth_') || input.id.startsWith('doorHeight_')));

        if (!isDoorLookupDimension && input.value.trim() === '') {
             valid = false;
             return;
        }

        // Numeric validation for all Width, Height fields
        // This covers:
        // - Window/Glass: Height (Inches), Width (Inches)
        // - Door: Width (name="Width" with id="doorWidth/Height")
        if ((input.name.includes('Height') || input.name.includes('Width')) && !input.readOnly && !isNumeric(input.value)) {
          valid = false; return;
        }
      }
      const fileInputs = section.querySelectorAll('input[type="file"]');
      let hasFile = false;
      fileInputs.forEach(fi => { if (fi.files && fi.files.length > 0) hasFile = true; });
      if (!hasFile) valid = false;
    });

    //document.getElementById('masterSubmitBtn').disabled = !valid;
    return valid;
  }

  /**
   * Updates the content of the summary tab with current form data and updates the summary tab button's state.
   */
  function updateSummary() {
    const summaryEl = document.getElementById('summary');
    const summaryTabBtn = document.getElementById('summaryTabBtn');
    if (!summaryEl) return;

    let html = '';
    const sections = document.querySelectorAll('#windows .form-section, #doors .form-section, #glass .form-section');
    sections.forEach(section => {
      const containerId = section.dataset.container;
      const idx = section.dataset.index;
      const tabName = TAB_MAP[containerId] || "Unknown";

      html += `<div class="form-section">
                 <h4>${tabName} #${idx}</h4>
                 <ul class="summary-item-list" style="list-style:none; padding:0; margin:0;">`; // Apply new class for font size

      section.querySelectorAll('input[type="text"], input[type="number"], select, textarea').forEach(input => {
        const rawVal = input.value.trim();
        let displayVal = rawVal || "<i>empty</i>";
        const isProblematic = (rawVal === '' || displayVal === "<i>empty</i>"); // Check for empty string or initial "empty" tag

        if (isProblematic) {
          displayVal = `<span class="summary-empty-value">${displayVal}</span>`;
        }
        html += `<li><b>${input.name}:</b> ${displayVal}</li>`;
      });

      section.querySelectorAll('input[type="file"]').forEach(fi => {
        const fileCount = fi.files ? fi.files.length : 0;
        let displayFiles = `${fileCount} file(s) selected`;
        const isProblematic = (fileCount === 0);

        if (isProblematic) {
          displayFiles = `<span class="summary-empty-value"><i>no files</i></span>`; // Consistent red for "no files"
        }
        html += `<li><b>${fi.name}:</b> ${displayFiles}</li>`;
      });

      html += `</ul></div>`;
    });

    summaryEl.innerHTML = html || "<p>No inputs yet.</p>";

    if (!isProjectComplete) { // Use the global flag
        if (validateAll()) {
          summaryTabBtn.classList.remove("summary-invalid");
          summaryTabBtn.classList.add("summary-valid");
          summaryTabBtn.textContent = "Inputs Complete";
        } else {
          summaryTabBtn.classList.remove("summary-valid");
          summaryTabBtn.classList.add("summary-invalid");
          summaryTabBtn.textContent = "Inputs Incomplete";
        }
    }
  }

  /**
   * Clears all input fields in the forms and resets file inputs.
   */
  function clearForms() {
    const allInputs = document.querySelectorAll('#windows input, #doors input, #glass input, #windows textarea, #doors textarea, #glass textarea, #windows select, #doors select, #glass select');
    allInputs.forEach(input => {
      if (input.readOnly) return; // Don't clear readonly fields

      if (input.type === 'file') {
        input.value = '';
      } else if (input.tagName === 'SELECT') {
        input.selectedIndex = 0;
      } else {
        input.value = '';
      }
    });

    // Re-validate to disable the submit button and update summary after clearing
    validateAll();
    updateSummary();
    // Clear local lookup status messages after clearing forms
    document.querySelectorAll('.door-lookup-status').forEach(el => {
        el.textContent = '';
        el.className = 'door-lookup-status';
    });
  }

  /**
   * Disables all user editable input fields (text, textarea, select, file) in the forms.
   * Read-only fields set by buildFields will remain as they are.
   */
  function disableAllUserInputs() {
    const allEditableInputs = document.querySelectorAll(
      '#windows input:not([readonly]), #doors input:not([readonly]), #glass input:not([readonly]),' +
      '#windows textarea:not([readonly]), #doors textarea:not([readonly]), #glass textarea:not([readonly]),' +
      '#windows select:not([readonly]), #doors select:not([readonly]), #glass select:not([readonly])'
    );
    const allSearchButtons = document.querySelectorAll('.door-search-btn'); // Target by class now
    const allLookupStatusDivs = document.querySelectorAll('.door-lookup-status');


    allEditableInputs.forEach(input => {
      input.disabled = true;
    });
    allSearchButtons.forEach(button => {
        button.disabled = true;
    });
    allLookupStatusDivs.forEach(div => {
        div.textContent = '';
        div.className = 'door-lookup-status';
    });
  }

  async function submitProductTypes(category) {
  // Decide prefix key to match doPost
  const key = category.toLowerCase().includes("window") ? "window"
            : category.toLowerCase().includes("door")   ? "door"
            : "glasswall";

  const plainData = {
    action: "saveProductTypes",
    projectNumber: projectNumber,   // comes from session
    category: category,             // "Windows" / "Doors" / "Glass Walls"
    // ✅ match the prefixed field names your doPost expects
    [`${key}_ExistingFrameType_common`]: document.querySelector(`#${key}s [name*="ExistingFrameType_common"]`)?.value || "",
    [`${key}_InteriorWallType_common`]:  document.querySelector(`#${key}s [name*="InteriorWallType_common"]`)?.value || "",
    [`${key}_ExteriorWallType_common`]:  document.querySelector(`#${key}s [name*="ExteriorWallType_common"]`)?.value || "",
  };

  // Handle Exterior Pictures (file input → base64)
  const fileInput = document.querySelector(`#${key}s input[name*="ExteriorPicturesURL_common"]`);
  if (fileInput && fileInput.files.length > 0) {
    const files = Array.from(fileInput.files);
    const base64Array = await Promise.all(
      files.map(file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result.split(',')[1]);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      }))
    );
    plainData[`${key}_ExteriorPicturesURL_common`] = base64Array.join("||");
    plainData[`${key}_ExteriorPicturesURL_common_name`] = files.map(f => f.name).join("||");
  }

  // POST to Apps Script
  await fetch(UPLOAD_URL, {
    method: "POST",
    headers: { "Content-Type": "application/x-www-form-urlencoded" },
    body: new URLSearchParams(plainData).toString()
  });
}


  // Event listener for the master submit button
  document.getElementById('masterSubmitBtn').addEventListener('click', async () => {

    prepareImageFields()
    const statusEl = document.getElementById('masterStatus');
    const sections = Array.from(document.querySelectorAll('#windows .form-section, #doors .form-section, #glass .form-section'));
    if (sections.length === 0) return;

    try {
  //let projectNumber = document.getElementById('ProjectNumber_1')?.value || '';
  let SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz8Xt95yliau1oJBfj1qm7ISrR6RwmkOy2d3mGBZiTNSwQIprry7wQcsZnt5htkLmPKQQ/exec';
  //origianl let SCRIPT_URL = "https://script.google.com/macros/s/AKfycbw44osy47azJbKBm3s4qcfkVncpkdT7buZPjJxk_3zuUPsVx88neupQIDSVUWsFYAZZ/exec"
  
    // INSERT THE FOLLOWING LINES OF CODE HERE
    // Always prefer sessionStorage
    //let projectNumber = sessionStorage.getItem('selectedProject') || document.getElementById('ProjectNumber_1')?.value || '';
    let projectNumber = sessionStorage.getItem('selectedProject')
                    || document.getElementById('projectNumberHidden')?.value
                    || document.querySelector('[name="window_ProjectNumber_1"]')?.value
                    || '';
    const deleteUrl = `${SCRIPT_URL}?action=deleteAll&projectNumber=${encodeURIComponent(projectNumber)}`;
    
    const deleteResponse = await fetch(deleteUrl);
    const deleteResult = await deleteResponse.json();
    
    if (deleteResult.result === 'error') {
        throw new Error(deleteResult.message);
    }
    
    console.log('Deletion successful:', deleteResult.message);

      let submitted = 0;
      for (let section of sections) {
        const containerId = section.dataset.container;
        const idx = parseInt(section.dataset.index, 10);
        const tabName = TAB_MAP[containerId] || 'Unknown';

        statusEl.textContent = `Submitting ${tabName} #${idx} (${submitted + 1}/${sections.length})…`;

        // Collect data manually (with Base64 files)
        const plainData = {};
        for (let input of section.querySelectorAll('input, select, textarea')) {
          // ⬅️ Skip common fields, they are handled separately by submitProductTypes()
          if (input.name && input.name.includes("common")) {
            continue;
          }

          if (input.type === 'file') {
            const files = Array.from(input.files);
            const base64Array = await Promise.all(files.map(file => new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result.split(',')[1]); // remove prefix
              reader.onerror = reject;
              reader.readAsDataURL(file);
            })));
            plainData[input.name] = base64Array.join("||");
            plainData[input.name + "_name"] = files.map(f => f.name).join("||");
          } else {
            plainData[input.name] = input.value.trim();
          }
        }

        plainData['formType'] = tabName;

        // Send data to the UPLOAD_URL
        const res = await fetch(UPLOAD_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams(plainData).toString()
        });
        const data = await res.json();
        if (data.result !== 'success') throw new Error(data.message || `Submit failed on ${tabName} #${idx}`);
        submitted++;
      }
      statusEl.textContent = `✅ All ${submitted} items submitted successfully!`;
      // 🔹 Call ProductTypes submission once per category
      await submitProductTypes("Windows");
      await submitProductTypes("Doors");
      await submitProductTypes("Glass Walls");

      statusEl.textContent += " | ProductTypes saved.";

      // Upon successful submission of all items:
      //clearForms(); // Clear all form fields
      //document.getElementById('masterSubmitBtn').disabled = true; // Disable the button
      statusEl.textContent += " Forms cleared, awaiting new entries."; // Update status message
    } catch (err) {
      console.error(err);
      statusEl.textContent = `❌ Error submitting. ${err.message}`;
      document.getElementById('masterSubmitBtn').disabled = false; // Re-enable if submission failed
    }
  });

  // Event listeners for input and change events to trigger validation and summary updates
  document.addEventListener('input', () => { validateAll(); updateSummary(); });
  document.addEventListener('change', () => { validateAll(); updateSummary(); });

  /**
   * Shows the selected tab and hides others.
   * @param {string} tabId - The ID of the tab content to show (e.g., 'windows').
   */
  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
    document.getElementById(tabId).classList.add('active');
  }


/**
 * Submits all data from the form, including additional features and files.
 */
async function submitAllData() {
    //document.getElementById('masterSubmitBtn').disabled = true;
    document.getElementById('masterStatus').textContent = 'Submitting...';

    try {
        const projectNumber = document.getElementById('window_ProjectNumber_1')?.value;
        if (!projectNumber) {
            throw new Error("Project number not found in sessionStorage.");
        }

        const allFormData = await collectAllFormData(projectNumber); // Pass projectNumber to the collection function
        
        // Submit the main form data
        if (allFormData.length > 0) {
            await submitFormData(allFormData);
        }

        // Log the success message
        console.log('All data submitted successfully.');
        document.getElementById('masterStatus').textContent = 'Submission successful!';

    } catch (error) {
        console.error("Submission failed:", error);
        //document.getElementById('masterStatus').textContent = 'Submission failed. Please check the console for errors.';
    } finally {
        document.getElementById('masterSubmitBtn').disabled = false;
    }
}




       /**
     * Fills out all text, number, and URL input fields with temporary data for testing.
     * This function is designed to be self-contained and easily added to any HTML form page.
     */
  function fillFormForTesting() {
  // Find all input elements that are textboxes, number inputs, or URL inputs.
  const textInputs = document.querySelectorAll('input[type="text"]');
  const numberInputs = document.querySelectorAll('input[type="number"]');
  const urlInputs = document.querySelectorAll('input[type="url"]');
  const dateInputs = document.querySelectorAll('input[type="date"]');
  const selectInputs = document.querySelectorAll('select');
  const textareaInputs = document.querySelectorAll('textarea');

  // Define some random data for a more realistic feel
  const randomWords = ['Lorem', 'Ipsum', 'Dolor', 'Sit', 'Amet', 'Consectetur'];
  const getRandomWord = () => randomWords[Math.floor(Math.random() * randomWords.length)];

  // Helper function to generate a random phone number format
  const generatePhoneNumber = () => `(555) 555-${Math.floor(1000 + Math.random() * 9000)}`;

  // Helper function to generate a random date in YYYY-MM-DD format
  const generateRandomDate = () => {
    const today = new Date();
    const randomDays = Math.floor(Math.random() * 30);
    today.setDate(today.getDate() - randomDays);
    return today.toISOString().split('T')[0];
  };

  // Fill all text inputs
  textInputs.forEach(input => {
    if (!input.readOnly) {
      // Use the new ID naming conventions to fill the specific door fields
      if (input.id.startsWith('door_doorWidth_')) {
        input.value = '58';
      } else if (input.id.startsWith('door_doorHeight_')) {
        input.value = '78.5';
      } else if (input.name.toLowerCase().includes('phone')) {
        input.value = generatePhoneNumber();
      } else if (input.name.toLowerCase().includes('name')) {
        input.value = `${getRandomWord()} ${getRandomWord()}`;
      } else if (input.name.toLowerCase().includes('address')) {
        input.value = `${Math.floor(Math.random() * 1000)} Main St.`;
      } else {
        input.value = `Test_${getRandomWord()}`;
      }
    }
  });

  // Fill all number inputs
  numberInputs.forEach(input => {
    if (!input.readOnly) {
      // Generate a random number for all other number inputs
      input.value = Math.floor(Math.random() * 91) + 10;
    }
  });

  // Fill all select inputs
  selectInputs.forEach(select => {
    if (!select.readOnly) {
      if (select.id.startsWith('window_AlternativeWindowRecommendation_')) {
        select.value = 'Single Awning';
      } else {
        const options = select.options;
        if (options.length > 1) {
          select.selectedIndex = Math.floor(Math.random() * (options.length - 1)) + 1;
        }
      }
    }
  });

  // Fill all textarea inputs
  textareaInputs.forEach(input => {
    if (!input.readOnly) {
      input.value = `Test note from fillFormForTesting at ${new Date().toLocaleString()}`;
    }
  });

  // Fill all URL inputs with a placeholder URL
  urlInputs.forEach(input => {
    if (!input.readOnly) {
      input.value = 'https://example.com/test-image.jpg';
    }
  });

  // Fill all date inputs
  dateInputs.forEach(input => {
    if (!input.readOnly) {
      input.value = generateRandomDate();
    }
  });
}

document.addEventListener('DOMContentLoaded', function() {
  const rawUserName = sessionStorage.getItem('installer');
  const displayUserName = rawUserName ? rawUserName.split('@')[0].toLowerCase() : null;
  const button = document.getElementById('fillFormsBtn');

  if (button) {
    if (displayUserName !== 'willmarbrin') {
      button.style.display = 'none'; // This hides the button
    } else {
      button.style.display = 'block'; // This shows the button
    }
  }
});

const PRODUCT_DETAILS_LOOKUP_URL = 'https://script.google.com/macros/s/AKfycbwzrdpEHiavYjT8Ww9zVokL89JBxsTCPosEPy67tM3hQzQNmEyI2yL0Nr3j2vm6N7X5AA/exec';

  /**
   * Fetches and displays detailed information for a specific project item.
   * @param {HTMLElement} iconElement - The icon that was clicked.
   * @param {string} itemType - The type of item (e.g., 'windows', 'doors', 'glass').
   * @param {number} itemNumber - The number of the item (e.g., 1, 2, 3).
   */
  async function expandInfo(iconElement, itemType, itemNumber) {
    const detailsContainer = document.getElementById(`details_${itemType}_${itemNumber}`);
    const spinner = `<p>Loading...</p>`;

    if (detailsContainer.classList.contains('active')) {
      detailsContainer.classList.remove('active');
      detailsContainer.innerHTML = '';
      return;
    }

    detailsContainer.innerHTML = spinner;
    detailsContainer.classList.add('active');

    try {
      const url = `${PRODUCT_DETAILS_LOOKUP_URL}?projectNumber=${encodeURIComponent(projectNumber)}&itemType=${encodeURIComponent(itemType)}&itemNumber=${encodeURIComponent(itemNumber)}`;
      console.log(`[DEBUG] Fetching details from URL: ${url}`);
      const response = await fetch(url);
      const data = await response.json();

      if (data && data.details) {
        let html = '<h5>Admin Assigned Details:</h5><ul>';
        for (const key in data.details) {
          html += `<li><b>${key}:</b> ${data.details[key]}</li>`;
        }
        html += '</ul>';
        detailsContainer.innerHTML = html;
      } else {
        detailsContainer.innerHTML = '<p>No details found.</p>';
      }

    } catch (error) {
      console.error('Error fetching product details:', error);
      detailsContainer.innerHTML = '<p>Error loading details.</p>';
    }
  }


/**
 * Loads form data from the Google Sheet via the App Script web app.
 */
/**
 * Loads form data from the Google Sheet via the App Script web app.
 */
async function loadFormData(projectNumber) {

  const url = `https://script.google.com/macros/s/AKfycbz8Xt95yliau1oJBfj1qm7ISrR6RwmkOy2d3mGBZiTNSwQIprry7wQcsZnt5htkLmPKQQ/exec?action=loadFormData&projectNumber=${encodeURIComponent(projectNumber)}`;
  //original url https://script.google.com/macros/s/AKfycbw44osy47azJbKBm3s4qcfkVncpkdT7buZPjJxk_3zuUPsVx88neupQIDSVUWsFYAZZ/exec
  try {
    
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP error! Status: ${response.status}`);
    }

    const data = await response.json();
    console.log("Full JSON result:", data);


// Fields we want to skip
const skipNames = ["Project Number", "Installer Name", "Door Number", "Window Number"];

// Utility to check if an element should be skipped
function shouldSkip(element) {
  if (!element) return true;
  
  return skipNames.includes(element.name);
}




// Utility: extract Google Drive file ID and return thumbnail URL
function getDriveThumbnail(url) {
  // Match .../file/d/<FILE_ID>/... pattern
  const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
  if (match) {
    console.log("✅ Extracted file ID:", match[1]); // use console.log instead of alert
    return `https://drive.google.com/uc?export=view&id=${match[1]}`;
  } else {
    console.warn("❌ No file ID match for:", url);
    return null;
  }
}



function appendValues(element, urls) {


  console.log("appendValues called for:", element.id, "urls:", urls);
  const existing = element.parentNode.querySelector(".values");
  if (existing) existing.remove();

  const container = document.createElement("div");
  container.className = "values";

  urls.forEach((url) => {
    url = url.trim();
    if (!url) return;

    const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
    const fileId = match ? match[1] : null;

    const fullUrl = fileId
      ? `https://drive.google.com/uc?export=view&id=${fileId}`
      : url;
    const thumbUrl = fileId
      ? `https://drive.google.com/thumbnail?id=${fileId}&sz=w200-h200`
      : null;

    const thumbItem = document.createElement("div");
    thumbItem.className = "thumb-item";
    thumbItem.style.display = "inline-block";
    thumbItem.style.position = "relative";

    if (thumbUrl) {
      const link = document.createElement("a");
      link.href = fullUrl;
      link.target = "_blank";

      const img = document.createElement("img");
      img.src = thumbUrl;
      img.style.width = "100px";
      img.style.height = "auto";
      img.style.margin = "4px";
      img.style.border = "1px solid #ccc";
      img.style.borderRadius = "6px";

      link.appendChild(img);
      thumbItem.appendChild(link);
    } else {
      const link = document.createElement("a");
      link.href = fullUrl;
      link.textContent = fullUrl;
      link.target = "_blank";
      link.style.display = "block";
      link.style.marginTop = "4px";
      link.style.color = "#007aff";
      thumbItem.appendChild(link);
    }

    // Delete button
    const del = document.createElement("button");
    del.type = "button";
    del.textContent = "×";
    del.className = "delete-thumb";
    del.style.position = "absolute";
    del.style.top = "0";
    del.style.right = "0";
    del.style.background = "red";
    del.style.color = "white";
    del.style.border = "none";
    del.style.borderRadius = "50%";
    del.style.cursor = "pointer";
    thumbItem.appendChild(del);

    // Hidden input to preserve URL for submission
    const hidden = document.createElement("input");
    hidden.type = "hidden";
    hidden.name = element.id + "_existing[]"; // tie to field
    hidden.value = fullUrl;
    thumbItem.appendChild(hidden);

    container.appendChild(thumbItem);
  });

  // Handle deletion
  container.addEventListener("click", (e) => {
    if (e.target.classList.contains("delete-thumb")) {
      e.target.closest(".thumb-item").remove();
    }
  });

  element.insertAdjacentElement("afterend", container);
}





// ----------------- Windows -----------------
if (data.windows && data.windows.length > 0) {
  data.windows.forEach((windowData) => {
    for (const id in windowData) {
      const element = document.getElementById(id);
      if (!shouldSkip(element)) {
        const value = windowData[id];
        if (element.type !== "file") {
          element.value = value;
        }

        // Handle Drive URLs
        if (typeof value === "string" && value.includes("drive.google.com")) {
          const urls = value.split(","); // multiple URLs separated by commas
          appendValues(element, urls);
        }
      }
    }
  });
}

// ----------------- Doors -----------------
if (data.doors && data.doors.length > 0) {
  data.doors.forEach((doorData) => {
    for (const id in doorData) {
      let element = document.getElementById(id);

      // Workaround for door width/height IDs to match HTML
      if (id.startsWith("door_Width_")) {
        const index = id.split("_")[2];
        element = document.getElementById(`door_doorWidth_${index}`);
      } else if (id.startsWith("door_Height_")) {
        const index = id.split("_")[2];
        element = document.getElementById(`door_doorHeight_${index}`);
      }

      if (!shouldSkip(element)) {
        const value = doorData[id];
        if (element.type !== "file") {
          element.value = value;
        }


        if (typeof value === "string" && value.includes("drive.google.com")) {
          const urls = value.split(",");
          appendValues(element, urls);
        }
      }
    }
  });
}

// ----------------- Glass Walls -----------------
if (data.glasswalls && data.glasswalls.length > 0) {
  data.glasswalls.forEach((glasswallData) => {
    for (const id in glasswallData) {
      const element = document.getElementById(id);
      if (!shouldSkip(element)) {
        const value = glasswallData[id];
        if (element.type !== "file") {
          element.value = value;
        }


        if (typeof value === "string" && value.includes("drive.google.com")) {
          const urls = value.split(",");
          appendValues(element, urls);
        }
      }
    }
  });
}

// ----------------- ProductTypes (common fields) -----------------
if (data.productTypes && data.productTypes.length > 0) {
  data.productTypes.forEach(prod => {
    const category = (prod["Product Category"] || "").toLowerCase();
    let prefix = "";
    if (category.includes("window")) prefix = "window";
    else if (category.includes("door")) prefix = "door";
    else if (category.includes("glass")) prefix = "glasswall";

    if (prefix) {
      // Map each ProductTypes column to your _common field names
      const mapping = {
        "Existing Frame Type": `${prefix}_ExistingFrameType_common`,
        "Interior Wall Type":  `${prefix}_InteriorWallType_common`,
        "Exterior Wall Type":  `${prefix}_ExteriorWallType_common`,
        "Exterior_Pictures_URL": `${prefix}_ExteriorPicturesURL_common`
      };

      for (const [col, htmlId] of Object.entries(mapping)) {
        const value = prod[col];
        if (!value) continue;

        const el = document.getElementById(htmlId);
        if (!el) continue;
if (el.type === "file") {
  const label = el.closest(".form-group")?.querySelector("label");

  if (value && typeof value === "string" && value.trim() !== "") {
    const count = value.split(",").filter(v => v.trim() !== "").length;

    if (label) {
      if (el.name.includes("InteriorPicturesURL") || el.id.includes("InteriorPicturesURL")) {
        // Always triggers if "InteriorPicturesURL" is in name or id
        label.textContent = `You have uploaded ${count} interior picture${count > 1 ? "s" : ""} before. 
        Resubmitting/editing the project requires the submission of images for all parts and tabs.`;
      } else if (el.name.includes("ExteriorPicturesURL") || el.id.includes("ExteriorPicturesURL")) {
        //label.textContent = `You have uploaded ${count} exterior picture${count > 1 ? "s" : ""} before. 
        //Resubmitting/editing the project requires the submission of images for all parts and tabs.`;
        document.getElementById('imgWarning').textContent = '⚠️ Editing the project requires the submission of images for all parts and tabs.';
        document.getElementById('imgWarning').style.color = 'red';
      } else {
        
        const fieldName = label.textContent.replace("*", "").trim() || el.name;
        label.textContent = `You have uploaded ${count} file${count > 1 ? "s" : ""} before for "${fieldName}". 
        Resubmitting/editing the project requires the submission of images for all parts and tabs.`;
        
      }
    }
  } else {
    if (label) {
      if (el.name.includes("InteriorPicturesURL") || el.id.includes("InteriorPicturesURL")) {
        label.textContent = "Choose interior pictures when uploading";
      } else if (el.name.includes("ExteriorPicturesURL") || el.id.includes("ExteriorPicturesURL")) {
        label.textContent = "Choose exterior pictures when uploading";
      } else {
        label.textContent = "Choose all related files when uploading";
      }
    }
  }
}




else {
          // Normal input/select
          el.value = value;
        }
      }
    }
  });
}


    // Optional: log in sections for readability
    if (data.windows) {
      console.log("Windows:", data.windows);
    }
    if (data.doors) {
      console.log("Doors:", data.doors);
    }
    if (data.glasswalls) {
      console.log("Glass Walls:", data.glasswalls);
    }

    return data; // in case you want to use it elsewhere
  } catch (err) {
    console.error("Error fetching form data:", err);
  }

  console.log("Windows data:", data.windows);
console.log("Doors data:", data.doors);
console.log("Glasswalls data:", data.glasswalls);
}






document.addEventListener('DOMContentLoaded', () => {
  if (projectNumber) {
    loadFormData(projectNumber);
  }



  // ✅ Attach to Master Submit button
  document.getElementById("masterSubmit").addEventListener("click", prepareImageFields);  
});


/**
 * Processes all file inputs to prepare data for submission
 */
function prepareImageFields() {
  const fileInputs = document.querySelectorAll("input[type='file']");
  const promises = [];
  
  fileInputs.forEach(fileInput => {
    const files = fileInput.files;
    const fieldId = fileInput.id;
    
    if (files.length > 0) {
      const fieldPromise = new Promise(resolve => {
        let filesRead = 0;
        const base64Array = [];
        const namesArray = [];
        
        for (let i = 0; i < files.length; i++) {
          const reader = new FileReader();
          reader.onload = (e) => {
            base64Array.push(e.target.result.split(',')[1]);
            namesArray.push(files[i].name);
            filesRead++;
            if (filesRead === files.length) {
              resolve({ fieldId, base64: base64Array, names: namesArray });
            }
          };
          reader.readAsDataURL(files[i]);
        }
      });
      promises.push(fieldPromise);
    }
  });

  return Promise.all(promises);
}

// Attach the new submission handler
document.getElementById("masterForm").addEventListener("submit", function(event) {
  event.preventDefault(); // Stop the form from submitting immediately

  prepareImageFields().then(results => {
    const data = {};
    const form = new FormData(event.target);
    form.forEach((value, key) => {
      data[key] = value;
    });


    results.forEach(result => {
      if (result) {
        const { fieldId, base64, names } = result;
        let baseFieldName = "";
        
        if (fieldId === "windowInteriorFiles" || fieldId === "doorInteriorFiles") {
          baseFieldName = "Interior_Pictures";
        } else if (fieldId === "windowExteriorFiles" || fieldId === "doorExteriorFiles" || fieldId === "projectExteriorFiles") {
          baseFieldName = "Exterior_Pictures";
        }

        if (baseFieldName) {
          data[`${baseFieldName}_data`] = base64.join("||");
          data[`${baseFieldName}_name`] = names.join("||");
        }
      }
    });

    // Send the data object to the Apps Script
    google.script.run
      .withSuccessHandler((response) => {
        if (response.result === 'success') {
          alert('Form submitted successfully!');
          // Add success logic here
        } else {
          alert('Error: ' + response.message);
        }
      })
      .doPost(data);
  });
});

function copyAllFromFirst(containerId) {
  const first = document.querySelector(`#${containerId} .form-section[data-index="1"]`);
  if (!first) return;

  const allSections = document.querySelectorAll(
    `#${containerId} .form-section[data-index]:not([data-index="1"])`
  );

  allSections.forEach(section => {
    const firstInputs = first.querySelectorAll('input, select, textarea');
    const currentInputs = section.querySelectorAll('input, select, textarea');

    firstInputs.forEach(fi => {
      if (fi.readOnly || fi.type === 'file') return; // skip readonly & file inputs
      const baseName = fi.name.replace(/_\d+$/, '');
      currentInputs.forEach(ci => {
        const currentBase = ci.name.replace(/_\d+$/, '');
        if (currentBase === baseName && !ci.readOnly && ci.type !== 'file') {
          ci.value = fi.value;
          if (ci.tagName === 'SELECT') ci.selectedIndex = fi.selectedIndex;
        }
      });
    });
  });

  // ✅ show status message
  const statusEl = document.getElementById(`copyStatus_${containerId}`);
  if (statusEl) {
    const label = containerId === "windows" ? "Window"
                : containerId === "doors"   ? "Door"
                : "Glass Wall";
    statusEl.textContent = `✅ All info from ${label} #1 copied to all other ${label.toLowerCase()}s.`;
    statusEl.style.color = "#27ae60"; // green success
  }

  // ✅ disable and gray out the button
  const btn = document.getElementById(`copyBtn_${containerId}`);
  if (btn) {
    btn.style.pointerEvents = "none";
    btn.style.opacity = "0.5";
    btn.textContent = "Copied ✔";
  }

  validateAll();
  updateSummary();
}
/* ===== IndexedDB Drafts — robust drop-in =====
   - Uses sessionStorage.selectedProject (fallbacks supported)
   - Saves fields + files (Blobs) per project key
   - Restores inputs and image previews
   - Exposes loaded draft as window.__installerDrafts[projectKey]
*/


async function openDraftDB() {
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = (e) => {
      const db = e.target.result;
      if (!db.objectStoreNames.contains(STORE_NAME)) {
        db.createObjectStore(STORE_NAME); // key is external (we use put(value, key))
      }
    };
    req.onsuccess = (e) => resolve(e.target.result);
    req.onerror = (e) => reject(e.target.error || e);
  });
}

function getProjectKey() {
  // prefer existing app sessionStorage key used by your app
  const a = sessionStorage.getItem('selectedProject') || sessionStorage.getItem('selectedProjectNumber');
  if (a) return a;
  // fallback to common hidden input used in this page
  const hid = document.getElementById('projectNumberHidden');
  if (hid && hid.value) return hid.value;
  // fallback to visible input field id="projectNumber"
  const visible = document.getElementById('projectNumber') || document.getElementById('projectNumberInput');
  if (visible && visible.value) return visible.value;
  return null;
}

async function saveDraftLocally() {
  try {
    const projectKey = getProjectKey();
    if (!projectKey) {
      alert('No project selected. Make sure a project is open (selectedProject in sessionStorage) or enter Project Number first.');
      return;
    }

    const db = await openDraftDB();
    const tx = db.transaction(STORE_NAME, 'readwrite');
    const store = tx.objectStore(STORE_NAME);

    const fields = {};
    const files = {};

    document.querySelectorAll('input, textarea, select').forEach((el, idx) => {
      const key = el.id || el.name || `field_${idx}`;

      // ✅ Skip if no key, readonly, or disabled
      if (!key || el.readOnly || el.disabled) return;

      if (el.type === 'file') {
        if (el.files && el.files.length) {
          files[key] = Array.from(el.files).map(f => ({
            name: f.name,
            type: f.type,
            size: f.size,
            file: f // structured-cloneable in modern browsers
          }));
        }
      } else if (el.type === 'checkbox' || el.type === 'radio') {
        fields[key] = !!el.checked;
      } else {
        // Always store a string (so even 0 or empty values are preserved)
        fields[key] = (el.value !== undefined && el.value !== null) ? String(el.value) : '';
      }
    });
    const timestamp = new Date().toISOString();
    await store.put({ project: projectKey, fields, files, savedAt: timestamp }, projectKey);

    setTimeout(() => {
      const msgEl = document.getElementById('saveMessage');
      document.getElementById('saveText').textContent =
        `💾 Draft saved for project: ${projectKey} at ${new Date(timestamp).toLocaleString()}`;
      msgEl.style.display = 'flex';
    }, 1000);
    debugLog('Saved draft', projectKey, { fields, files });

  } catch (err) {
    console.error('saveDraftLocally error', err);
    alert('Failed to save draft: ' + (err && err.message ? err.message : err));
  }
}




async function loadDraftLocally() {
  try {
    const projectKey = getProjectKey();
    if (!projectKey) {
      alert('No project selected. Make sure a project is open (selectedProject in sessionStorage) or enter Project Number first.');
      return;
    }
    const db = await openDraftDB();
    const tx = db.transaction(STORE_NAME, 'readonly');
    const req = tx.objectStore(STORE_NAME).get(projectKey);
    const draft = await new Promise((res, rej) => {
      req.onsuccess = () => res(req.result);
      req.onerror = () => rej(req.error || 'load-error');
    });

    if (!draft) {
      alert(`No draft found for project: ${projectKey}`);
      return;
    }

    // restore fields
    for (const [k, v] of Object.entries(draft.fields || {})) {
      const el = document.getElementById(k) || document.querySelector(`[name="${k}"]`); // ✅ prefer ID first
      if (!el || el.readOnly || el.disabled) continue;

      if (el.tagName === 'TEXTAREA') {
        el.value = v;
      } else if (el.tagName === 'SELECT') {
        el.value = v;
      } else if (el.type === 'checkbox' || el.type === 'radio') {
        el.checked = (el.value === v || v === true || v === 'true');
      } else if (el.type !== 'file') {
        el.value = v;
      }

      // trigger any listeners your page uses
      el.dispatchEvent(new Event('input', { bubbles: true }));
      el.dispatchEvent(new Event('change', { bubbles: true }));
    }

    // restore file previews
    window.__installerDrafts = window.__installerDrafts || {};
    window.__installerDrafts[projectKey] = draft; // keep blobs for submit

    const fileInputs = Array.from(document.querySelectorAll('input[type="file"]')).filter(fi => fi.name || fi.id);
    for (const fi of fileInputs) {
      const key = fi.id || fi.name;
      let preview = document.getElementById(`__draft_preview_${key}`);
      if (!preview) {
        preview = document.createElement('div');
        preview.id = `__draft_preview_${key}`;
        preview.style.marginTop = '6px';
        preview.style.display = 'flex';
        preview.style.flexWrap = 'wrap';
        fi.insertAdjacentElement('afterend', preview);
      } else {
        preview.innerHTML = '';
      }

      const savedFiles = (draft.files && draft.files[key]) || [];
      if (savedFiles.length === 0) {
        preview.innerHTML = '<small style="color:#777">No saved files for this field</small>';
        continue;
      }

      for (let i = 0; i < savedFiles.length; i++) {
        const fmeta = savedFiles[i];
        const fileBlob = fmeta.file instanceof Blob
          ? fmeta.file
          : new Blob([fmeta.file], { type: fmeta.type || 'application/octet-stream' });
        const url = URL.createObjectURL(fileBlob);

        const card = document.createElement('div');
        card.style.margin = '4px';
        card.style.textAlign = 'center';
        card.style.maxWidth = '140px';
        card.style.fontSize = '12px';

        const img = document.createElement('img');
        img.src = url;
        img.alt = fmeta.name;
        img.style.maxWidth = '120px';
        img.style.maxHeight = '90px';
        img.style.display = 'block';
        img.style.border = '1px solid #ccc';
        img.style.borderRadius = '4px';
        img.style.objectFit = 'cover';
        img.onload = () => { URL.revokeObjectURL(url); };

        const label = document.createElement('div');
        label.textContent = fmeta.name;
        label.style.whiteSpace = 'nowrap';
        label.style.overflow = 'hidden';
        label.style.textOverflow = 'ellipsis';
        label.style.maxWidth = '120px';

        const del = document.createElement('button');
        del.type = 'button';
        del.textContent = 'Remove';
        del.style.display = 'block';
        del.style.marginTop = '4px';
        del.style.fontSize = '11px';
        del.addEventListener('click', () => {
          draft.files[key].splice(i, 1);
          window.__installerDrafts[projectKey] = draft;
          loadDraftLocally().catch(console.error);
        });

        card.appendChild(img);
        card.appendChild(label);
        card.appendChild(del);
        preview.appendChild(card);
      }
    }

    setTimeout(() => {
      const savedAt = draft.savedAt ? new Date(draft.savedAt).toLocaleString() : "unknown time";

      // update permanent banner
      const msgEl = document.getElementById('draftMessage');
      msgEl.style.display = 'block';
      msgEl.textContent = `ℹ️ Information loaded from draft saved last ${savedAt}. 
      Note that pictures loaded before must be reuploaded.`;

    }, 1000);
    //document.getElementById('draftMessage').textContent = `ℹ️ Information loaded from draft saved last ${savedAt}. 
    //Note that pictures loaded before must be reuploaded.`;
    debugLog('Loaded draft', projectKey, draft);
  } catch (err) {
    console.error('loadDraftLocally error', err);
    alert('Failed to load draft: ' + (err && err.message ? err.message : err));
  }
}


async function clearDraftLocally() {
  try {
    const projectKey = getProjectKey();
    if (!projectKey) { alert('No project selected.'); return; }
    const db = await openDraftDB();
    const tx = db.transaction(STORE_NAME, 'readwrite');
    tx.objectStore(STORE_NAME).delete(projectKey);
    await new Promise((res, rej) => { tx.oncomplete = res; tx.onerror = () => rej(tx.error || 'del-failed'); tx.onabort = () => rej(tx.error || 'del-abort');});
    if (window.__installerDrafts) delete window.__installerDrafts[projectKey];
    // remove preview nodes
    document.querySelectorAll('[id^="__draft_preview_"]').forEach(n => n.remove());
    alert(`🗑️ Draft cleared for project: ${projectKey}`);
    debugLog('Cleared draft', projectKey);
  } catch (err) {
    console.error('clearDraftLocally error', err);
    alert('Failed to clear draft: ' + (err && err.message ? err.message : err));
  }
}

// Expose to global scope (so inline onclick handlers keep working)
window.saveDraftLocally = saveDraftLocally;
window.loadDraftLocally = loadDraftLocally;
window.clearDraftLocally = clearDraftLocally;

// Optional: auto-notify on page load if a draft exists for current project
(async function showDraftNoticeOnLoad(){
  try {
    const projectKey = getProjectKey();
    if (!projectKey) return;
    const db = await openDraftDB();
    const tx = db.transaction(STORE_NAME, 'readonly');
    const req = tx.objectStore(STORE_NAME).get(projectKey);
    req.onsuccess = () => {
      if (req.result) {
        // small unobtrusive notice
        const n = document.createElement('div');
        n.style.background = '#fffbe6';
        n.style.border = '1px solid #ffecb3';
        n.style.padding = '8px';
        n.style.margin = '8px auto';
        n.style.maxWidth = '720px';
        n.style.borderRadius = '6px';
        n.style.fontSize = '13px';
        n.textContent = `Draft available for project ${projectKey}. Click "Load Draft" to restore saved values.`;
        const container = document.body.querySelector('form') || document.body;
        container.insertAdjacentElement('beforebegin', n);
      }
    };
    req.onerror = () => {};
  } catch(e){ /* ignore */ }
})();





</script>

</body>
</html>