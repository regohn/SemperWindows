<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Installer Details</title>
  <button type="button" onclick="fillFormForTesting()" id="fillFormsBtn">Fill Forms</button>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 1rem; background: #fafafa; }
    h2 { text-align: center; }

    .header-bar {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px 20px; background-color: #f2f2f7; border-bottom: 1px solid #e5e5ea; margin-bottom: 1rem;
    }
    .logoff-link {
      color: #007aff; text-decoration: none; font-weight: 600; font-size: 14px;
      padding: 8px 12px; border: 1px solid #007aff; border-radius: 6px;
      transition: background-color 0.2s,color 0.2s;
    }
    .logoff-link:hover { background-color: #007aff; color: #fff; }

    .add-btn {
      font-size: .85rem; padding: 6px 14px; border-radius: 6px;
      border: 1px solid #007aff; background: #007aff; color: #fff; text-decoration: none;
      transition: background .2s;
    }
    .add-btn:hover { background: #005ecb; }

    .tabs { display: flex; justify-content: center; margin-bottom: 1rem; gap: 6px; flex-wrap: wrap; }
    .tab { padding: 10px 20px; cursor: pointer; border: 1px solid #ccc; background: #f4f4f4; }
    .tab.active { background: #4e54c8; color: #fff; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }

    .tab.summary-invalid { background: #e74c3c; color: #fff; }
    .tab.summary-valid { background: #27ae60; color: #fff; }
    .tab.project-completed { background: #6c757d; color: #fff; cursor: default; } /* Style for completed project tab */


    .form-section {
      max-width: 520px; margin: 20px auto; padding: 18px;
      border-radius: 14px; background: #fff;
      box-shadow: 0 4px 12px rgba(0,0,0,.05); border: 1px solid #eee;
    }
    .form-section h4 {
      margin: 0 0 10px; font-size: 1.05rem; font-weight: 600; color: #333;
      padding-bottom: 8px; border-bottom: 1px solid #eee;
    }
    .form-group { margin-bottom: 12px; }
    .form-group label { display:block; font-weight:500; font-size: 14px; color:#333; margin-bottom: 4px; }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px;
      background: #f9f9f9; font-size: 14px; box-sizing: border-box; transition: border-color .2s;
      font-family: inherit;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { border-color:#007aff; outline: none; background: #fff; }
    .form-group textarea { resize: vertical; min-height: 80px; }

    .submit-btn {
      background: #007aff; color: #fff; padding: 10px 14px; border: 0; border-radius: 8px;
      font-size: 14px; cursor: pointer; width: 100%; transition: background-color .2s;
    }
    .submit-btn:hover:not(:disabled) { background: #005ecb; }
    .submit-btn:disabled { background: #ccc; cursor: not-allowed; } /* Added disabled style */

    #masterStatus { display:inline-block; margin-top: 10px; font-size: 14px; }
    #projectCompletionMessage {
        text-align: center;
        color: #e74c3c; /* Red color for completion message */
        font-weight: bold;
        margin-bottom: 10px;
        font-size: 1.1em;
    }

    /* Styles for side-by-side inputs and button */
    .door-dimensions-group { /* Renamed from .dimension-search-group to match user's snippet */
      display: flex;
      align-items: flex-end;
      gap: 10px;
    }

    .door-dimensions-group .form-group { /* Renamed from .dimension-search-group to match user's snippet */
        flex-grow: 1; /* Distribute space evenly */
        margin-bottom: 0;
    }

    .door-dimensions-group button { /* Renamed from .dimension-search-group to match user's snippet */
      padding: 10px 15px;
      border: 1px solid #007aff;
      background-color: #007aff;
      color: #fff;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
      height: 38px; /* Match height of inputs */
      display: flex;
      align-items: center;
      justify-content: center;
      white-space: nowrap; /* Prevent button text from wrapping */
    }
    .door-dimensions-group button:hover { /* Renamed from .dimension-search-group to match user's snippet */
      background-color: #005ecb;
    }

    .door-lookup-status { /* New style for the local status message */
        font-size: 0.9em;
        margin-top: 5px;
        margin-bottom: 10px;
        text-align: center;
        color: #555; /* Neutral color */
        min-height: 1.5em; /* Reserve space to avoid layout shifts */
    }
    .door-lookup-status.error { color: #e74c3c; }
    .door-lookup-status.success { color: #27ae60; }
    .door-lookup-status.warning { color: #f39c12; }

    /* New style for smaller font in summary tab */
    .summary-item-list {
        font-size: 0.85em; /* Approximately 10pt */
    }
    /* New style for red text for empty values in summary tab */
    .summary-empty-value {
        color: #e74c3c; /* Red color for empty/no files */
        font-weight: bold;
    }


    @media (max-width: 768px) {
      body { padding: .5rem; }
      .tab { flex: 1 1 45%; text-align: center; }
      .form-section { max-width: 100%; margin: 12px 0; padding: 14px; }
      .door-dimensions-group { /* Renamed from .dimension-search-group to match user's snippet */
        flex-direction: column; /* Stack vertically on small screens */
        align-items: stretch;
      }
      .door-dimensions-group button { /* Renamed from .dimension-search-group to match user's snippet */
        width: 100%; /* Full width button on small screens */
      }
    }
    @media (max-width: 480px) { .tab { flex: 1 1 100%; } }
  </style>
</head>
<body>
  <div class="header-bar">
    <span>Welcome, <span id="userName"></span>!</span>
    <a href="#" class="logoff-link" onclick="logoff()">Logoff</a>
  </div>

  <div style="display:flex; justify-content:center; margin-bottom:1rem;">
    <a id="projectSummaryLink" class="add-btn">Project Summary</a>
  </div>

  <h2>Installer Details</h2>
  <div id="projectCompletionMessage" aria-live="polite"></div> <!-- New div for completion message -->
  <div id="projectInfo" style="text-align:center; margin-bottom: .5rem;"></div>
  <div id="salesInfo" style="text-align:center; margin-bottom: 1rem; font-weight: bold;"></div>

  <div class="tabs">
    <div class="tab active" onclick="showTab('windows')">Windows Sold</div>
    <div class="tab" onclick="showTab('doors')">Doors Sold</div>
    <div class="tab" onclick="showTab('glass')">Glass Walls Sold</div>
    <div id="summaryTabBtn" class="tab summary-invalid" onclick="showTab('summary')">Inputs Incomplete</div>
  </div>

  <div id="windows" class="tab-content active"></div>
  <div id="doors" class="tab-content"></div>
  <div id="glass" class="tab-content"></div>
  <div id="summary" class="tab-content"></div>

  <div style="max-width:520px; margin: 20px auto; text-align:center;">
    <button id="masterSubmitBtn" class="submit-btn" onclick="submitAllData()" disabled>Submit All</button>
    <br>
    <button type="button" id="hiddenSubmitFeaturesBtn"  onclick="submitOnlyAdditionalFeatures()" >Submit Additional Features</button>
    <div id="masterStatus" aria-live="polite"></div>
  </div>

<script>
  // URL for the Google Apps Script that fetches project details and product types
  const scriptURL = 'https://script.google.com/macros/s/AKfycbxSDvmdLSCpyq-tdRiJlUm4jItjAfxJbOZ018vwHRzlENBMSy43nxjgoHtAtiwFSetB/exec';
  // URL for submitting data
  const UPLOAD_URL = 'https://script.google.com/macros/s/AKfycbw44osy47azJbKBm3s4qcfkVncpkdT7buZPjJxk_3zuUPsVx88neupQIDSVUWsFYAZZ/exec';
  // URL for checking data (not used in this specific fix, but kept for context)
  const CHECK_URL  = 'https://script.google.com/macros/s/AKfycbzBqeJFJejvhiB_ChmM71sqNZnvvz_PtXvmRhRF_3Nv0l42Orwjt55OffxiIoGZVxKBMw/exec';
  // New URL for the Google Apps Script to perform the door dimension lookup
  const LOOKUP_URL = 'https://script.google.com/macros/s/AKfycbzyvxUGOW7WpUt_37JEcVBGSA8zogDTvz00banbuSJgy22NbYWmLCPvdMx8e47MTohrnw/exec'; // This should be updated with the new deployment URL for the new script

  // Mapping of container IDs to human-readable tab names
  const TAB_MAP = { windows: 'Windows Sold', doors: 'Doors Sold', glass: 'Glass Walls Sold' };

  let isProjectComplete = false; // Global flag for project completion status

  /**
   * Logs the user off by clearing session storage and redirecting to the login page.
   */
function logoff() {
    sessionStorage.removeItem('installer');
    sessionStorage.removeItem('role');
    // FIX: Use a relative path for local file redirection
    window.location.href = 'windowsloginpage.html';
}

  // Immediately-invoked function to initialize the header with user information and project summary link
  (function initHeader(){
    const rawUserName = sessionStorage.getItem('installer');
    const displayUserName = rawUserName ? rawUserName.split('@')[0] : 'Guest';
    document.getElementById('userName').textContent = displayUserName;

    const role = sessionStorage.getItem('role');
    const projectSummaryLink = document.getElementById('projectSummaryLink');
    // Set the correct link for project summary based on user role
    projectSummaryLink.href = (role && role.toLowerCase() === 'admin')
      ? 'adminsprojectsummary.html' : 'projectsummary.html';
  })();

  // Retrieve project number and installer name from session storage
  const projectNumber = sessionStorage.getItem('selectedProject');
  const installerName = sessionStorage.getItem('installer');

  // Log sessionStorage values
  console.log("Project Number from sessionStorage:", projectNumber);
  console.log("Installer Name from sessionStorage:", installerName);

  // If project number or installer name is missing, redirect to login page
  if (!projectNumber || !installerName) {
    // FIX: Use an absolute path for redirection
    window.location.href = window.location.origin + '/windowsloginpage.html';
  }

  // Display current project and installer information
  document.getElementById('projectInfo').innerText =
    `Project: ${projectNumber} | Installer: ${installerName}`;

  // Fetch project details and product types from the Google Apps Script
  fetch(scriptURL + '?projectNumber=' + encodeURIComponent(projectNumber))
    .then(res => res.json())
    .then(data => {
      // Log the full data response
      console.log("Raw data from scriptURL:", data);

      if (data && data.length > 0) {
        const row = data[0];
        console.log("First row of data (from scriptURL):", row);
        // Helper function to safely get data, handling potential undefined or trimmed keys
        const get = (key) => (row[key] ?? row[key?.trim?.()] ?? '');
        const windowsCount = parseInt(get('Windows Sold')) || 0;
        const doorsCount   = parseInt(get('Doors Sold'))   || 0;
        const glassCount   = parseInt(get('Glass Walls Sold')) || 0;

        // Log the parsed counts
        console.log(`Counts: Windows=${windowsCount}, Doors=${doorsCount}, Glass Walls=${glassCount}`);

        // Display the counts of items sold
        document.getElementById('salesInfo').textContent =
          `Windows Sold: ${windowsCount} | Doors Sold: ${doorsCount} | Glass Walls Sold: ${glassCount}`;

        // Create forms for each category, passing the specific product types for each item
        createForms('windows', windowsCount, 'Windows', row.WindowTypes || []);
        createForms('doors', doorsCount, 'Doors', row.DoorTypes || []);
        createForms('glass', glassCount, 'Glass Walls', row.GlassTypes || []);

        // Validate all forms and update the summary tab
        validateAll();
        updateSummary();

        // Check project status and update UI accordingly
        const projectStatus = get('Project Status');
        if (projectStatus && projectStatus.toLowerCase() === 'complete') {
          isProjectComplete = true; // Set global flag
          document.getElementById('projectCompletionMessage').textContent = 'This project has been completed.';
          document.getElementById('masterSubmitBtn').disabled = true;
          // Update the summary tab button to reflect completion
          const summaryTabBtn = document.getElementById('summaryTabBtn');
          summaryTabBtn.classList.remove("summary-invalid", "summary-valid");
          summaryTabBtn.classList.add("project-completed");
          summaryTabBtn.textContent = "Project Completed";
          disableAllUserInputs(); // Disable all editable fields
        }

        // Attach event listener for door search buttons after forms are created
        attachDoorSearchListeners();

      } else {
        console.log("No data or empty data array returned from scriptURL for project:", projectNumber);
        document.getElementById('salesInfo').textContent = 'No sales data found for this project.';
      }
    })
    .catch(err => {
      console.error("Error retrieving sales data from scriptURL:", err);
      document.getElementById('salesInfo').textContent = 'Error retrieving sales data.';
    });

  /**
   * Creates the form sections for a given category (windows, doors, or glass walls).
   * @param {string} containerId - The ID of the HTML container for the forms (e.g., 'windows').
   * @param {number} count - The number of forms to create for this category.
   * @param {string} label - The human-readable label for the category (e.g., 'Windows').
   * @param {string[]} productTypesArray - An array of product types for the specific items in this category.
   */
  function createForms(containerId, count, label, productTypesArray = []) {
    const container = document.getElementById(containerId);
    if (!container) return;
    if (count === 0) {
      container.innerHTML = `<p>No ${label} sold.</p>`;
      return;
    }
    let html = '';
    for (let i = 1; i <= count; i++) {
      // Get the specific product type for this item number (idx)
      const itemProductType = productTypesArray[i - 1] || ''; // Use i-1 for 0-based array index
      html += `
        <div class="form-section" data-container="${containerId}" data-index="${i}">
          <h4>${label} #${i}</h4>
          ${buildFields(containerId, i, itemProductType)}
        </div>
      `;
    }
    container.innerHTML = html;
  }

  /**
   * Builds the HTML fields for a single form section based on its category.
   * @param {string} containerId - The ID of the parent container (e.g., 'windows').
   * @param {number} idx - The index of the current item (e.g., 1 for Window #1).
   * @param {string} itemProductType - The specific product type for this item, to be displayed in the read-only field.
   * @returns {string} The HTML string for the form fields.
   */
/**
 * Builds the HTML fields for a single form section based on its category.
 * @param {string} containerId - The ID of the parent container (e.g., 'windows').
 * @param {number} idx - The index of the current item (e.g., 1 for Window #1).
 * @param {string} itemProductType - The specific product type for this item, to be displayed in the read-only field.
 * @returns {string} The HTML string for the form fields.
 */
function buildFields(containerId, idx, itemProductType = '') {
  // Helper function for creating a text input field
  const text = (label, name, inputType = 'text', extra = '') => {
      let idName = name.replace(/\s/g, ''); // Remove all spaces
      // Special handling for simpler IDs when specifically needed
      if (name === 'Height (Inches)') { // Ensure primary fields also have simple IDs
          idName = 'Height';
      } else if (name === 'Width (Inches)') { // Ensure primary fields also have simple IDs
          idName = 'Width';
      }
      return `<div class="form-group"><label>${label}</label><input type="${inputType}" name="${name}" id="${idName}_${idx}" ${extra}></div>`;
  };
  // Helper function for creating a select dropdown
  const select = (label, name, options) =>
    `<div class="form-group"><label>${label}</label><select name="${name}" id="${name.replace(/\s/g, '')}_${idx}">${options.map(o=>`<option value="${o}">${o}</option>`).join('')}</select></div>`; // Added ID
  // Helper function for creating multiple file input fields
  const fileMulti = (label, name) =>
    `<div class="form-group"><label>${label.replaceAll('_',' ')}</label><input type="file" name="${name}" id="${name.replace(/\s/g, '')}_${idx}" accept="image/*" multiple></div>`; // Added ID
  // Helper function to make an input read-only with a value
  const readOnly = v => `value="${v}" readonly`;

  // Define the options for the new dropdown menu
  const additionalOptions = [
      "ProSolar Shade Plus",
      "Laminating",
      "Spectra Clear EZ",
      "CleanObscure / Decorative",
      "CA Urban Wildlife Compliant",
      "Tempered both Sides",
      "Premium Frame Colors",
      "Mulled Units",
      "Premium Lock and Casement Finishes",
      "Grids",
      "Color Matched Grids",
      "Sound Control Package",
      "Premium Screen"
  ];

  // Helper function for the new dropdown
const additionalFeaturesSelect = (idx) => `
  <div class="form-group">
      <label>Additional Features</label>
      <select name="Additional_Features" id="AdditionalFeatures_${idx}" onchange="populateDependentDropdown(this, ${idx})">
          <option value="">-- Select an option --</option>
          ${additionalOptions.map(o => `<option value="${o}">${o}</option>`).join('')}
      </select>
  </div>
  <div id="DependentFeatureGroup_${idx}" class="form-group" style="display:none;">
      <label>Dependent Feature Details</label>
      <select id="DependentFeature_${idx}">
          <option value="">-- Select a feature --</option>
      </select>
      <button type="button" onclick="addFeature(${idx})">Add</button>
  </div>
  <div id="SelectedFeatures_${idx}" class="form-group">
      <label>Selected Features:</label>
      <ul id="SelectedFeaturesList_${idx}" style="padding-left:16px; margin:0;"></ul>
  </div>
`;


  if (containerId === 'windows') {
    const alternativeWindowOptions = [
      {value: "", text: "Select..."},
      {value: "Single Hung", text: "Single Hung"},
      {value: "Slider Window", text: "Slider Window"},
      {value: "End Vent Slider", text: "End Vent Slider"},
      {value: "Picture Window", text: "Picture Window"},
      {value: "Casement", text: "Casement"},
      {value: "Casement Picture", text: "Casement Picture"},
      {value: "Casement & Picture", text: "Casement & Picture"},
      {value: "Casement-Picture", text: "Casement-Picture"},
      {value: "Casement-Casement", text: "Casement-Casement"},
      {value: "Single Awning", text: "Single Awning"},
      {value: "Picture over Awning", text: "Picture over Awning"},
      {value: "Trap Top Single", text: "Trap Top Single"},
      {value: "Arch Top Single", text: "Arch Top Single"},
      {value: "Custom Shapes: (Specify in Notes)", text: "Custom Shapes: (Specify in Notes)"}
    ];
    return `
      ${text('Project Number','Project Number', 'text', readOnly(projectNumber))}
      ${text('Installer Name','Installer Name', 'text', readOnly(installerName))}
      ${text('Window Number','Window Number', 'text', readOnly(idx))}
      ${text('Window Location','Window Location')}
      ${text('Existing Frame Type','Existing Frame Type')}
      ${text('Height (Inches)','Height', 'number')}
      ${text('Width (Inches)','Width', 'number')}
      ${text('Interior Wall Type','Interior Wall Type')}
      ${fileMulti('Interior_Pictures_URL','Interior_Pictures_URL')}
      ${text('Interior Notes','Interior Notes')}
      ${text('Exterior Wall Type','Exterior Wall Type')}
      ${fileMulti('Exterior_Pictures_URL','Exterior_Pictures_URL')}
      ${text('Exterior Notes','Exterior Notes')}
      <div class="form-group">
        <label>Alternative Window Recommendation</label>
        <select name="Alternative Window Recommendation" id="AlternativeWindowRecommendation_${idx}">
          ${alternativeWindowOptions.map(o => `<option value="${o.value}">${o.text}</option>`).join('')}
        </select>
      </div>
      ${text('Window Type Sold','Window Type Sold', 'text', readOnly(itemProductType))}
      ${additionalFeaturesSelect(idx)}
    `;
  }

  if (containerId === 'doors') {
    const onclickAttr = `onclick="lookupDoorRecommendation(${idx})"`;
    return `
      ${text('Project Number','Project Number', 'text', readOnly(projectNumber))}
      ${text('Installer Name','Installer Name', 'text', readOnly(installerName))}
      ${text('Door Number','Door Number', 'text', readOnly(idx))}
      ${text('Door Location','Door Location')}
      ${text('Existing Frame Type','Existing Frame Type')}
      <div class="door-dimensions-group">
        <div class="form-group">
          <label>Door Dimension Width (Inches)</label>
          <input type="text" name="Width" id="doorWidth_${idx}" />
        </div>
        <div class="form-group">
          <label>Door Dimension Height (Inches)</label>
          <input type="text" name="Height" id="doorHeight_${idx}" />
        </div>
        <button type="button" class="door-search-btn" data-door-index="${idx}">Search</button>
      </div>
      <div id="doorLookupStatus_${idx}" class="door-lookup-status" aria-live="polite"></div>
      ${text('Interior Wall Type','Interior Wall Type')}
      ${fileMulti('Interior_Pictures_URL','Interior_Pictures_URL')}
      ${text('Interior Notes','Interior Notes')}
      ${text('Exterior Wall Type','Exterior Wall Type')}
      ${fileMulti('Exterior_Pictures_URL','Exterior_Pictures_URL')}
      ${text('Exterior Notes','Exterior Notes')}
      ${text('Alternative Door Recommendation','Alternative Door Recommendation', 'text', readOnly(''))}
      ${text('Door Type Sold','Door Type Sold', 'text', readOnly(itemProductType))}
      `;
  }

  if (containerId === 'glass') {
    return `
      ${text('Project Number','Project Number', 'text', readOnly(projectNumber))}
      ${text('Installer Name','Installer Name', 'text', readOnly(installerName))}
      ${text('Glass Number','Glass Number', 'text', readOnly(idx))}
      ${text('Glass Location','Glass Location')}
      ${text('Existing Frame Type','Existing Frame Type')}
      ${text('Height (Inches)','Height (Inches)', 'number')}
      ${text('Width (Inches)','Width (Inches)', 'number')}
      ${text('Interior Wall Type','Interior Wall Type')}
      ${fileMulti('Interior_Pictures_URL','Interior_Pictures_URL')}
      ${text('Interior Notes','Interior Notes')}
      ${text('Exterior Wall Type','Exterior Wall Type')}
      ${fileMulti('Exterior_Pictures_URL','Exterior_Pictures_URL')}
      ${text('Exterior Notes','Exterior Notes')}
      ${text('Alternative Glass Recommendation','Alternative Glass Recommendation')}
      ${text('Glass Type Sold','Glass Type Sold', 'text', readOnly(itemProductType))}
      `;
  }
}

  // Helper function to check if a string is numeric (Updated to be more robust)
  const isNumeric = (val) => {
    if (val === null || val === undefined) return false;
    const str = String(val).trim(); // Convert to string and trim
    return str !== '' && !isNaN(Number(str));
  };

  /**
   * Attaches delegated event listeners for door search buttons.
   */
  function attachDoorSearchListeners() {
      const doorsContainer = document.getElementById('doors');
      if (doorsContainer && !doorsContainer.dataset.listenersAttached) { // Prevent attaching multiple times
          doorsContainer.addEventListener('click', (event) => {
              if (event.target.classList.contains('door-search-btn')) {
                  if (isProjectComplete) { // Use the global flag
                      const masterStatusEl = document.getElementById('masterStatus');
                      masterStatusEl.textContent = 'Project is completed, no further actions allowed.';
                      return;
                  }
                  const doorIndex = parseInt(event.target.dataset.doorIndex, 10);
                  if (!isNaN(doorIndex)) {
                      lookupDoorRecommendation(doorIndex);
                  }
              }
          });
          doorsContainer.dataset.listenersAttached = 'true'; // Mark as attached
          console.log('[DEBUG] Door search event listener attached to #doors container.');
      }
  }


  /**
   * Performs a lookup for door recommendations based on provided dimensions and door type.
   * @param {number} doorIndex - The index of the door form section.
   */
  async function lookupDoorRecommendation(doorIndex) {
    console.log(`[DEBUG] lookupDoorRecommendation called for doorIndex: ${doorIndex}`);

    const widthInput = document.getElementById(`doorWidth_${doorIndex}`);
    const heightInput = document.getElementById(`doorHeight_${doorIndex}`);
    const doorTypeSoldInput = document.getElementById(`DoorTypeSold_${doorIndex}`); // Get Door Type Sold
    const altDoorRecInput = document.getElementById(`AlternativeDoorRecommendation_${doorIndex}`);
    const doorLookupStatusEl = document.getElementById(`doorLookupStatus_${doorIndex}`);

    // Clear previous status and recommendation
    doorLookupStatusEl.textContent = '';
    doorLookupStatusEl.className = 'door-lookup-status'; // Reset classes
    if (altDoorRecInput) altDoorRecInput.value = ''; // Clear recommendation field

    const width = widthInput ? widthInput.value.trim() : '';
    const height = heightInput ? heightInput.value.trim() : '';
    const doorTypeSold = doorTypeSoldInput ? doorTypeSoldInput.value.trim() : ''; // Get value

    console.log(`[DEBUG] lookupDoorRecommendation: Retrieved width value: '${width}'`);
    console.log(`[DEBUG] lookupDoorRecommendation: Retrieved height value: '${height}'`);
    console.log(`[DEBUG] lookupDoorRecommendation: Retrieved doorTypeSold value: '${doorTypeSold}'`);

    if (!isNumeric(width) || !isNumeric(height)) {
      doorLookupStatusEl.textContent = '❌ Please enter valid numeric values for Width and Height.';
      doorLookupStatusEl.classList.add('error');
      console.error(`[DEBUG] Validation failed for width: '${width}' or height: '${height}'`);
      return;
    }
    // New validation for doorTypeSold
    if (doorTypeSold === '') {
      doorLookupStatusEl.textContent = '❌ "Door Type Sold" cannot be empty for lookup.';
      doorLookupStatusEl.classList.add('error');
      console.error(`[DEBUG] Validation failed: Door Type Sold is empty.`);
      return;
    }


    doorLookupStatusEl.textContent = `Searching for door dimensions ${width} x ${height} and type "${doorTypeSold}"...`;
    doorLookupStatusEl.classList.add('warning');
    if (altDoorRecInput) altDoorRecInput.value = 'Searching...';

    await new Promise(resolve => setTimeout(resolve, 300)); // 300ms delay

    try {
      // Include doorTypeSold in the query parameters
      const response = await fetch(`${LOOKUP_URL}?width=${encodeURIComponent(width)}&height=${encodeURIComponent(height)}&doorTypeSold=${encodeURIComponent(doorTypeSold)}`);
      const data = await response.json();

      if (data && data.recommendation && data.recommendation !== "Not Found") {
        if (altDoorRecInput) altDoorRecInput.value = data.recommendation;
        doorLookupStatusEl.textContent = `✅ Door recommendation found for ${width} x ${height}, type "${doorTypeSold}".`;
        doorLookupStatusEl.classList.remove('warning');
        doorLookupStatusEl.classList.add('success');
      } else {
        if (altDoorRecInput) altDoorRecInput.value = 'Not Found';
        doorLookupStatusEl.textContent = `⚠️ No door recommendation found for dimensions ${width} x ${height}, type "${doorTypeSold}".`;
        doorLookupStatusEl.classList.remove('warning');
        doorLookupStatusEl.classList.add('warning');
      }
    } catch (error) {
      console.error('[DEBUG] Error during door recommendation lookup:', error);
      if (altDoorRecInput) altDoorRecInput.value = 'Error';
      doorLookupStatusEl.textContent = `❌ Error fetching door recommendation for ${width} x ${height}, type "${doorTypeSold}".`;
      doorLookupStatusEl.classList.remove('warning');
      doorLookupStatusEl.classList.add('error');
    }
  }


  /**
   * Validates all form sections to ensure required fields are filled and numeric fields are valid.
   * @returns {boolean} True if all forms are valid, false otherwise.
   */
/**
   * Validates all form sections to ensure required fields are filled and numeric fields are valid.
   * @returns {boolean} True if all forms are valid, false otherwise.
   */
  function validateAll() {
    const allSections = document.querySelectorAll('#windows .form-section, #doors .form-section, #glass .form-section');
    if (allSections.length === 0) {
      document.getElementById('masterSubmitBtn').disabled = true;
      return false;
    }
    let valid = true;

    allSections.forEach(section => {
      // Inputs to validate: all text inputs, selects, textareas that are NOT readonly
      const inputs = section.querySelectorAll('input[type="text"]:not([readonly]), input[type="number"]:not([readonly]), select:not([readonly]), textarea:not([readonly])');
      for (let input of inputs) {
        // Add this new condition to exempt the additional features dropdowns
        if (input.name === 'Additional_Features' || input.id.startsWith('DependentFeature_')) {
            continue; // Skip this input
        }

        const isDoorLookupDimension = (input.id && (input.id.startsWith('doorWidth_') || input.id.startsWith('doorHeight_')));

        if (!isDoorLookupDimension && input.value.trim() === '') {
             valid = false;
             return;
        }

        if ((input.name.includes('Height') || input.name.includes('Width')) && !input.readOnly && !isNumeric(input.value)) {
          valid = false; return;
        }
      }
      const fileInputs = section.querySelectorAll('input[type="file"]');
      let hasFile = false;
      fileInputs.forEach(fi => { if (fi.files && fi.files.length > 0) hasFile = true; });
      if (!hasFile) valid = false;
    });

    document.getElementById('masterSubmitBtn').disabled = !valid;
    return valid;
  }

  /**
   * Updates the content of the summary tab with current form data and updates the summary tab button's state.
   */
  function updateSummary() {
    const summaryEl = document.getElementById('summary');
    const summaryTabBtn = document.getElementById('summaryTabBtn');
    if (!summaryEl) return;

    let html = '';
    const sections = document.querySelectorAll('#windows .form-section, #doors .form-section, #glass .form-section');
    sections.forEach(section => {
      const containerId = section.dataset.container;
      const idx = section.dataset.index;
      const tabName = TAB_MAP[containerId] || "Unknown";

      html += `<div class="form-section">
                 <h4>${tabName} #${idx}</h4>
                 <ul class="summary-item-list" style="list-style:none; padding:0; margin:0;">`; // Apply new class for font size

      section.querySelectorAll('input[type="text"], input[type="number"], select, textarea').forEach(input => {
        const rawVal = input.value.trim();
        let displayVal = rawVal || "<i>empty</i>";
        const isProblematic = (rawVal === '' || displayVal === "<i>empty</i>"); // Check for empty string or initial "empty" tag

        if (isProblematic) {
          displayVal = `<span class="summary-empty-value">${displayVal}</span>`;
        }
        html += `<li><b>${input.name}:</b> ${displayVal}</li>`;
      });

      section.querySelectorAll('input[type="file"]').forEach(fi => {
        const fileCount = fi.files ? fi.files.length : 0;
        let displayFiles = `${fileCount} file(s) selected`;
        const isProblematic = (fileCount === 0);

        if (isProblematic) {
          displayFiles = `<span class="summary-empty-value"><i>no files</i></span>`; // Consistent red for "no files"
        }
        html += `<li><b>${fi.name}:</b> ${displayFiles}</li>`;
      });

      html += `</ul></div>`;
    });

    summaryEl.innerHTML = html || "<p>No inputs yet.</p>";

    if (!isProjectComplete) { // Use the global flag
        if (validateAll()) {
          summaryTabBtn.classList.remove("summary-invalid");
          summaryTabBtn.classList.add("summary-valid");
          summaryTabBtn.textContent = "Inputs Complete";
        } else {
          summaryTabBtn.classList.remove("summary-valid");
          summaryTabBtn.classList.add("summary-invalid");
          summaryTabBtn.textContent = "Inputs Incomplete";
        }
    }
  }

  /**
   * Clears all input fields in the forms and resets file inputs.
   */
  function clearForms() {
    const allInputs = document.querySelectorAll('#windows input, #doors input, #glass input, #windows textarea, #doors textarea, #glass textarea, #windows select, #doors select, #glass select');
    allInputs.forEach(input => {
      if (input.readOnly) return; // Don't clear readonly fields

      if (input.type === 'file') {
        input.value = '';
      } else if (input.tagName === 'SELECT') {
        input.selectedIndex = 0;
      } else {
        input.value = '';
      }
    });

    // Re-validate to disable the submit button and update summary after clearing
    validateAll();
    updateSummary();
    // Clear local lookup status messages after clearing forms
    document.querySelectorAll('.door-lookup-status').forEach(el => {
        el.textContent = '';
        el.className = 'door-lookup-status';
    });
  }

  /**
   * Disables all user editable input fields (text, textarea, select, file) in the forms.
   * Read-only fields set by buildFields will remain as they are.
   */
  function disableAllUserInputs() {
    const allEditableInputs = document.querySelectorAll(
      '#windows input:not([readonly]), #doors input:not([readonly]), #glass input:not([readonly]),' +
      '#windows textarea:not([readonly]), #doors textarea:not([readonly]), #glass textarea:not([readonly]),' +
      '#windows select:not([readonly]), #doors select:not([readonly]), #glass select:not([readonly])'
    );
    const allSearchButtons = document.querySelectorAll('.door-search-btn'); // Target by class now
    const allLookupStatusDivs = document.querySelectorAll('.door-lookup-status');


    allEditableInputs.forEach(input => {
      input.disabled = true;
    });
    allSearchButtons.forEach(button => {
        button.disabled = true;
    });
    allLookupStatusDivs.forEach(div => {
        div.textContent = '';
        div.className = 'door-lookup-status';
    });
  }


  // Event listener for the master submit button
  document.getElementById('masterSubmitBtn').addEventListener('click', async () => {
    const statusEl = document.getElementById('masterStatus');
    const sections = Array.from(document.querySelectorAll('#windows .form-section, #doors .form-section, #glass .form-section'));
    if (sections.length === 0) return;

    try {
      validateAll();
      if (document.getElementById('masterSubmitBtn').disabled) {
        statusEl.textContent = 'Please complete all fields and add at least one photo per item.';
        return;
      }

      let submitted = 0;
      for (let section of sections) {
        const containerId = section.dataset.container;
        const idx = parseInt(section.dataset.index, 10);
        const tabName = TAB_MAP[containerId] || 'Unknown';

        statusEl.textContent = `Submitting ${tabName} #${idx} (${submitted + 1}/${sections.length})…`;

        // Collect data manually (with Base64 files)
        const plainData = {};
        for (let input of section.querySelectorAll('input, select, textarea')) {
          if (input.type === 'file') {
            const files = Array.from(input.files);
            const base64Array = await Promise.all(files.map(file => new Promise((resolve, reject) => {
              const reader = new FileReader();
              reader.onload = () => resolve(reader.result.split(',')[1]); // remove prefix
              reader.onerror = reject;
              reader.readAsDataURL(file);
            })));
            plainData[input.name] = base64Array.join("||");
            plainData[input.name + "_name"] = files.map(f => f.name).join("||");
          } else {
            plainData[input.name] = input.value.trim();
          }
        }
        plainData['formType'] = tabName;

        // Send data to the UPLOAD_URL
        const res = await fetch(UPLOAD_URL, {
          method: "POST",
          headers: { "Content-Type": "application/x-www-form-urlencoded" },
          body: new URLSearchParams(plainData).toString()
        });
        const data = await res.json();
        if (data.result !== 'success') throw new Error(data.message || `Submit failed on ${tabName} #${idx}`);
        submitted++;
      }
      statusEl.textContent = `✅ All ${submitted} items submitted successfully!`;

      // Upon successful submission of all items:
      clearForms(); // Clear all form fields
      document.getElementById('masterSubmitBtn').disabled = true; // Disable the button
      statusEl.textContent += " Forms cleared, awaiting new entries."; // Update status message
    } catch (err) {
      console.error(err);
      statusEl.textContent = `❌ Error submitting. ${err.message}`;
      document.getElementById('masterSubmitBtn').disabled = false; // Re-enable if submission failed
    }

    try {
        await submitOnlyAdditionalFeatures();
    } catch (error) {
        console.error("Additional features submission failed:", error);
    }    
  });

  // Event listeners for input and change events to trigger validation and summary updates
  document.addEventListener('input', () => { validateAll(); updateSummary(); });
  document.addEventListener('change', () => { validateAll(); updateSummary(); });

  /**
   * Shows the selected tab and hides others.
   * @param {string} tabId - The ID of the tab content to show (e.g., 'windows').
   */
  function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
    document.querySelector(`.tab[onclick="showTab('${tabId}')"]`).classList.add('active');
    document.getElementById(tabId).classList.add('active');
  }


/**
 * Populates a dependent dropdown based on the selected value of another dropdown.
 * @param {HTMLSelectElement} selectElement - The 'Additional Features' dropdown.
 * @param {number} idx - The index of the form section.
 */
async function populateDependentDropdown(selectElement, idx) {
    const LOOKUP_ADDITIONAL_FEATURES_URL = 'https://script.google.com/macros/s/AKfycbyxFyynoELkEkEmNK4uto4A5dTUI9GTCUQakjGBCscNSWjX93CqY2soaiaLYRHeXlMddQ/exec';
    const selectedValue = selectElement.value;
    const dependentGroup = document.getElementById(`DependentFeatureGroup_${idx}`);
    const dependentSelect = document.getElementById(`DependentFeature_${idx}`);

    // Clear previous options and show a loading message
    dependentSelect.innerHTML = '<option value="">Searching...</option>';
    dependentSelect.disabled = true; // Disable while loading

    if (!selectedValue) {
        // Hide the dependent dropdown if no option is selected
        dependentGroup.style.display = 'none';
        return;
    }

    // Show the dependent dropdown group
    dependentGroup.style.display = 'block';

    try {
        const response = await fetch(`${LOOKUP_ADDITIONAL_FEATURES_URL}?feature=${encodeURIComponent(selectedValue)}`);
        const data = await response.json();

        // Clear the "Searching..." message
        dependentSelect.innerHTML = '<option value="">-- Select a feature --</option>';

        if (data && data.options && data.options.length > 0) {
            data.options.forEach(option => {
                const newOption = document.createElement('option');
                newOption.value = option;
                newOption.textContent = option;
                dependentSelect.appendChild(newOption);
            });
        } else {
            const noOptions = document.createElement('option');
            noOptions.value = '';
            noOptions.textContent = 'No options available';
            dependentSelect.appendChild(noOptions);
        }
    } catch (error) {
        console.error("Error fetching dependent features:", error);
        // Clear the "Searching..." message and add an error option
        dependentSelect.innerHTML = '<option value="">-- Select a feature --</option>';
        const errorOption = document.createElement('option');
        errorOption.value = '';
        errorOption.textContent = 'Error loading options';
        dependentSelect.appendChild(errorOption);
    } finally {
        dependentSelect.disabled = false; // Re-enable the dropdown
    }
}

// Temporary storage per window
const selectedFeaturesMap = {};

function addFeature(idx) {
  const feature = document.getElementById(`AdditionalFeatures_${idx}`).value;
  const value = document.getElementById(`DependentFeature_${idx}`).value;
  if (!feature || !value) return;

  // Initialize if first time
  if (!selectedFeaturesMap[idx]) selectedFeaturesMap[idx] = [];

  selectedFeaturesMap[idx].push({ feature, value });

  // Update UI list
  const listEl = document.getElementById(`SelectedFeaturesList_${idx}`);
  const li = document.createElement("li");
  li.textContent = `${feature} → ${value}`;
  listEl.appendChild(li);

  // Reset dropdowns
  document.getElementById(`AdditionalFeatures_${idx}`).selectedIndex = 0;
  document.getElementById(`DependentFeatureGroup_${idx}`).style.display = "none";
}


async function submitAllData() {
    document.getElementById('masterSubmitBtn').disabled = true;
    document.getElementById('masterStatus').textContent = 'Submitting...';

    const allFormData = await collectAllFormData();
    
    if (allFormData.length === 0) {
        document.getElementById('masterStatus').textContent = 'No data to submit.';
        document.getElementById('masterSubmitBtn').disabled = false;
        return;
    }

    try {
        if (allFormData.length > 0) {
            await submitAllForms(allFormData);
        }

        document.getElementById('masterStatus').textContent = 'All data submitted successfully!';
    } catch (error) {
        console.error('Submission failed:', error);
        document.getElementById('masterStatus').textContent = 'Submission failed: ' + error.message;
    } finally {
        document.getElementById('masterSubmitBtn').disabled = false;
    }
}

/**
 * Submits additional features data to the Google Sheet.
 * @param {object[]} additionalFeaturesData - An array of objects containing the data.
 */
async function submitAdditionalFeatures(additionalFeaturesData) {
    const SUBMIT_ADDITIONAL_FEATURES_URL = 'https://script.google.com/macros/s/AKfycbyxFyynoELkEkEmNK4uto4A5dTUI9GTCUQakjGBCscNSWjX93CqY2soaiaLYRHeXlMddQ/exec';
    
    if (additionalFeaturesData.length === 0) {
        console.log('No additional features to submit.');
        return;
    }

    try {
        await fetch(SUBMIT_ADDITIONAL_FEATURES_URL, {
            method: 'POST',
            body: JSON.stringify(additionalFeaturesData),
            headers: {'Content-Type': 'application/json'},
            mode: 'no-cors' // This is essential for a successful cross-origin request
        });

        console.log('Additional features submission initiated. Check Google Apps Script logs for details.');

    } catch (error) {
        console.error("Error during fetch for additional features:", error);
    }
}


/**
 * Submits all data from the form, including additional features and files.
 */
async function submitAllData() {
    document.getElementById('masterSubmitBtn').disabled = true;
    document.getElementById('masterStatus').textContent = 'Submitting...';

    try {
        const allFormData = await collectAllFormData();
        const additionalFeaturesData = collectAdditionalFeaturesData();
        
        // Submit the main form data
        if (allFormData.length > 0) {
            await submitFormData(allFormData); // Assuming a function submitFormData exists
        }

        // Submit the additional features data
        if (additionalFeaturesData.length > 0) {
            await submitAdditionalFeatures(additionalFeaturesData);
        }

        // Log the success message
        console.log('All data submitted successfully.');
        document.getElementById('masterStatus').textContent = 'Submission successful!';

    } catch (error) {
        console.error("Submission failed:", error);
        document.getElementById('masterStatus').textContent = 'Submission failed. Please check the console for errors.';
    } finally {
        document.getElementById('masterSubmitBtn').disabled = false;
    }
}

/**
 * Submits additional features data to the Google Sheet.
 * This function is fire-and-forget; it does not check for a response.
 * @param {object[]} additionalFeaturesData - An array of objects containing the data.
 */
async function submitAdditionalFeatures(additionalFeaturesData) {
    const SUBMIT_ADDITIONAL_FEATURES_URL = 'https://script.google.com/macros/s/AKfycbyxFyynoELkEkEmNK4uto4A5dTUI9GTCUQakjGBCscNSWjX93CqY2soaiaLYRHeXlMddQ/exec';
    
    if (additionalFeaturesData.length === 0) {
        console.log('No additional features to submit.');
        return;
    }

    try {
        await fetch(SUBMIT_ADDITIONAL_FEATURES_URL, {
            method: 'POST',
            body: JSON.stringify(additionalFeaturesData),
            headers: {
                'Content-Type': 'application/json'
            },
            mode: 'no-cors'
        });

        console.log('Additional features submission initiated. Check Google Apps Script logs for details.');
    } catch (error) {
        console.error("Error during fetch for additional features:", error);
        // Do not throw here. The main submitAllData function handles errors.
    }
}

/**
 * Collects data from all form sections into a single array.
 * @returns {Promise<object[]>} - An array of all form data.
 */
async function collectAllFormData() {
    const allFormData = [];

    // Collect data from the main forms (windows, doors, etc.)
    const allSections = document.querySelectorAll('.form-section');
    allSections.forEach(section => {
        const formData = {};
        const inputs = section.querySelectorAll('input, select');
        inputs.forEach(input => {
            formData[input.name] = input.value;
        });
        allFormData.push(formData);
    });

    // You can also add other data collection logic here if needed,
    // like the additional features data that is collected separately.
    const additionalFeaturesData = collectAdditionalFeaturesData();
    if (additionalFeaturesData.length > 0) {
        allFormData.push({ 'Additional Features': additionalFeaturesData });
    }

    return allFormData;
}

function collectAdditionalFeaturesData() {
  const additionalFeaturesData = [];

  Object.keys(selectedFeaturesMap).forEach(idx => {
    const form = document.querySelector(`#windows .form-section[data-index="${idx}"]`);
    if (!form) return;

    const projectNumber = form.querySelector('[name="Project Number"]').value;
    const itemNumber = form.querySelector('[name="Window Number"]').value;
    const productType = form.querySelector('[name="Window Type Sold"]').value;

    selectedFeaturesMap[idx].forEach(pair => {
      additionalFeaturesData.push({
        'Project Number': projectNumber,
        'Product Category': 'Window',
        'Item Number': itemNumber,
        'Product Type': productType,
        'Additional Feature': pair.feature,
        'Additional Value': pair.value
      });
    });
  });

  // --- ADD THIS LINE FOR TESTING ---
  //alert('Additional Features Data Captured: \n' + JSON.stringify(additionalFeaturesData, null, 2));
  // ---------------------------------

  return additionalFeaturesData;
}


       /**
     * Fills out all text, number, and URL input fields with temporary data for testing.
     * This function is designed to be self-contained and easily added to any HTML form page.
     */
    function fillFormForTesting() {
        // Find all input elements that are textboxes, number inputs, or URL inputs.
        const textInputs = document.querySelectorAll('input[type="text"]');
        const numberInputs = document.querySelectorAll('input[type="number"]');
        const urlInputs = document.querySelectorAll('input[type="url"]');
        const dateInputs = document.querySelectorAll('input[type="date"]');
        
        // Define some random data for a more realistic feel
        const randomWords = ['Lorem', 'Ipsum', 'Dolor', 'Sit', 'Amet', 'Consectetur'];
        const getRandomWord = () => randomWords[Math.floor(Math.random() * randomWords.length)];

        // Helper function to generate a random phone number format
        const generatePhoneNumber = () => `(555) 555-${Math.floor(1000 + Math.random() * 9000)}`;

        // Helper function to generate a random date in YYYY-MM-DD format
        const generateRandomDate = () => {
            const today = new Date();
            const randomDays = Math.floor(Math.random() * 30);
            today.setDate(today.getDate() - randomDays);
            return today.toISOString().split('T')[0];
        };

        // Fill all text inputs
        textInputs.forEach(input => {
            if (!input.readOnly) {
                // Add a check for door dimension inputs by their ID or name
                if (input.id.startsWith('doorWidth_')) {
                    input.value = 58;
                } else if (input.id.startsWith('doorHeight_')) {
                    input.value = 78.5;
                } else if (input.name.toLowerCase().includes('phone')) {
                    input.value = generatePhoneNumber();
                } else if (input.name.toLowerCase().includes('name')) {
                    input.value = `${getRandomWord()} ${getRandomWord()}`;
                } else if (input.name.toLowerCase().includes('address')) {
                    input.value = `${Math.floor(Math.random() * 1000)} Main St.`;
                } else {
                    input.value = `Test_${getRandomWord()}`;
                }
            }
        });

        const selectInputs = document.querySelectorAll('select');
        selectInputs.forEach(select => {
            if (!select.readOnly) {
                // Check for the specific select field by its name
                if (select.name === 'Alternative Window Recommendation') {
                    select.value = 'Single Awning';
                } else {
                    // For other select elements, you can select a random option
                    const options = select.options;
                    if (options.length > 1) {
                        select.selectedIndex = Math.floor(Math.random() * (options.length - 1)) + 1; // Skip the default "Select..." option
                    }
                }
            }
        });        

        // Fill all number inputs
        numberInputs.forEach(input => {
            if (!input.readOnly) {
                // Check for specific door dimension names and fill them with your requested values
                if (input.name === 'Door Dimension Width (Inches)') {
                    input.value = 58;
                } else if (input.name === 'Door Dimension Height (Inches)') {
                    input.value = 78.5;
                } else {
                    // Generate a random number for other number inputs
                    input.value = Math.floor(Math.random() * 91) + 10;
                }
            }
        });

        // Fill all URL inputs with a placeholder URL
        urlInputs.forEach(input => {
            if (!input.readOnly) {
                input.value = 'https://example.com/test-image.jpg';
            }
        });
        
        // Fill all date inputs
        dateInputs.forEach(input => {
             if (!input.readOnly) {
                 input.value = generateRandomDate();
             }
        });
    }

/**
 * Submits only the additional features data.
 * This is for testing and debugging purposes.
 */
async function submitOnlyAdditionalFeatures() {
    // Show a status message to the user
    const statusDiv = document.createElement('div');
    statusDiv.id = 'additionalFeaturesStatus';
    statusDiv.style.margin = '10px 0';
    statusDiv.textContent = 'Submitting additional features...';
    document.body.appendChild(statusDiv);

    try {
        const additionalFeaturesData = collectAdditionalFeaturesData();
        
        if (additionalFeaturesData.length === 0) {
            statusDiv.textContent = 'No additional features data to submit.';
            return;
        }

        // Use the corrected submitAdditionalFeatures function
        await submitAdditionalFeatures(additionalFeaturesData);

        statusDiv.textContent = 'Additional features submitted successfully!';

    } catch (error) {
        statusDiv.textContent = 'Submission failed. Check the console for errors.';
        console.error("Submission failed:", error);
    }
}
document.addEventListener('DOMContentLoaded', function() {
  const rawUserName = sessionStorage.getItem('installer');
  const displayUserName = rawUserName ? rawUserName.split('@')[0].toLowerCase() : null;
  const button = document.getElementById('fillFormsBtn');

  if (button) {
    if (displayUserName !== 'willmarbrin') {
      button.style.display = 'none'; // This hides the button
    } else {
      button.style.display = 'block'; // This shows the button
    }
  }
});
</script>
</body>
</html>
